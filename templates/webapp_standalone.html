<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order - KH·ªà MILKTEA</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1A5336">
    <link rel="apple-touch-icon" href="/static/logo.png">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{--primary:#1A5336;--primary-light:#2d7a4a;--accent:#C9A86C;--bg:#FDF8F3;--text:#333;--text-light:#666;--border:#e8e0d8;--danger:#e74c3c;--success:#27ae60}
        body{background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:var(--text);min-height:100vh}
        .login-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
        .login-screen.hidden{display:none}
        .login-box{background:#fff;padding:30px;border-radius:20px;text-align:center;width:100%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
        .login-logo{width:80px;height:80px;margin-bottom:15px;border-radius:12px}
        .login-title{font-size:22px;font-weight:700;color:var(--primary);margin-bottom:5px}
        .login-sub{font-size:13px;color:var(--text-light);margin-bottom:25px}
        .pin-input{width:100%;padding:15px;font-size:24px;text-align:center;border:2px solid var(--border);border-radius:12px;letter-spacing:10px;font-weight:700;outline:none}
        .pin-input:focus{border-color:var(--primary)}
        .pin-input.error{border-color:var(--danger);animation:shake .3s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .login-btn{width:100%;padding:15px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;margin-top:15px;cursor:pointer}
        .login-error{color:var(--danger);font-size:13px;margin-top:10px;min-height:20px}
        .app-container{display:none;padding-bottom:90px}
        .app-container.active{display:block}
        .header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);color:#fff;padding:12px 15px;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.15)}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .order-num{font-size:11px;opacity:.8;background:rgba(255,255,255,.2);padding:4px 8px;border-radius:12px}
        .brand{font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
        .brand img{width:32px;height:32px;border-radius:8px;border:2px solid rgba(255,255,255,.3)}
        .staff-name{font-size:11px;opacity:.9;cursor:pointer}
        .customer-input{width:100%;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.1);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;outline:none}
        .customer-input:focus{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.3)}
        .customer-input::placeholder{color:rgba(255,255,255,.7)}
        .search-wrap{padding:12px 15px;background:#fff;border-bottom:1px solid var(--border)}
        .search-box{display:flex;align-items:center;background:#f5f5f5;border-radius:25px;padding:8px 15px;gap:10px}
        .search-box svg{width:18px;height:18px;color:var(--text-light);flex-shrink:0}
        .search-input{flex:1;border:none;background:transparent;font-size:14px;outline:none}
        .search-input::placeholder{color:#999}
        .search-clear{width:20px;height:20px;border:none;background:#ddd;border-radius:50%;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center}
        .search-clear.show{display:flex}
        .categories{display:flex;flex-wrap:wrap;padding:12px 15px;gap:10px;background:#fff;border-bottom:1px solid var(--border)}
        .cat-btn{width:calc(50% - 5px);text-align:center;flex-shrink:0;padding:10px 18px;border-radius:25px;border:2px solid var(--border);background:#fff;color:var(--text-light);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
        .cat-btn:active{transform:scale(.95)}
        .cat-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(26,83,54,.3)}
        .products{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:15px}
        .product-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1);cursor:pointer;border:1px solid var(--border);transition:all .2s}
        .product-card:active{transform:scale(.96)}
        .prod-img{width:100%;aspect-ratio:1;object-fit:cover;background:#f5f5f5}
        .prod-img.loaded{animation:none;background:#f9f9f9}
        .prod-info{padding:10px 8px;text-align:center}
        .prod-name{font-size:11px;font-weight:600;line-height:1.3;height:30px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
        .prod-price{font-size:13px;font-weight:700;color:var(--primary);margin-top:4px}
        .no-results{grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:12px 15px;display:none;align-items:center;box-shadow:0 -4px 20px rgba(0,0,0,.15);z-index:100;gap:12px}
        .cart-bar.show{display:flex}
        .cart-preview{flex:1;display:flex;align-items:center;gap:12px;cursor:pointer;padding:10px 12px;background:linear-gradient(135deg,#f9f9f9,#f0f0f0);border-radius:12px}
        .cart-badge{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
        .cart-text{flex:1}
        .cart-label{font-size:11px;color:var(--text-light)}
        .cart-total{font-size:17px;font-weight:700;color:var(--primary)}
        .cart-btn{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:#fff;padding:12px 20px;border-radius:25px;font-size:13px;font-weight:600;z-index:300;opacity:0;transition:all .3s ease}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;backdrop-filter:blur(2px)}
        .modal-overlay.show{display:flex}
        .modal{background:#fff;width:100%;max-height:90vh;border-radius:24px 24px 0 0;display:flex;flex-direction:column;animation:slideUp .3s ease}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-close{width:36px;height:36px;border:none;background:#f0f0f0;border-radius:50%;font-size:20px;cursor:pointer}
        .modal-product{display:flex;align-items:center;gap:12px;flex:1}
        .modal-img{width:55px;height:55px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
        .modal-name{font-size:16px;font-weight:700}
        .modal-price{font-size:14px;color:var(--primary);font-weight:600}
        .modal-body{padding:15px;overflow-y:auto;flex:1}
        .qty-section{display:flex;justify-content:space-between;align-items:center;padding:14px;background:linear-gradient(135deg,#f9f9f9,#f5f5f5);border-radius:14px;margin-bottom:15px}
        .qty-label{font-weight:600;font-size:15px}
        .qty-control{display:flex;align-items:center;gap:15px}
        .qty-btn{width:40px;height:40px;border:none;background:#fff;border-radius:12px;font-size:22px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .qty-num{font-size:20px;font-weight:700;min-width:35px;text-align:center}
        .section-label{font-size:12px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin:15px 0 10px}
        .section-hint{font-weight:400;font-size:11px;color:#999}
        .topping-header{display:flex;justify-content:space-between;align-items:center;margin:15px 0 10px}
        .toggle-wrap{display:flex;align-items:center;gap:8px}
        .toggle-label{font-size:11px;color:var(--text-light)}
        .toggle{position:relative;width:44px;height:24px;background:#ddd;border-radius:12px;cursor:pointer;transition:background .2s}
        .toggle.active{background:var(--danger)}
        .toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
        .toggle.active::after{transform:translateX(20px)}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .chip{padding:10px 14px;border:2px solid var(--border);border-radius:25px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;transition:all .15s}
        .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chip.exclude{border-color:var(--danger);color:var(--danger)}
        .chip.exclude.active{background:var(--danger);color:#fff;border-color:var(--danger)}
        .chip.compensate{border-color:var(--success);color:var(--success)}
        .chip.compensate.active{background:var(--success);color:#fff;border-color:var(--success)}
        .chip.disabled{opacity:0.4;cursor:not-allowed;pointer-events:none}
        .chip-note.active{background:#555;border-color:#555}
        .custom-note{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:12px;font-size:14px;margin-top:10px;outline:none;resize:none;font-family:inherit}
        .custom-note:focus{border-color:var(--primary)}
        .modal-footer{padding:15px;border-top:1px solid var(--border)}
        .add-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer}
        .cart-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .cart-title{font-size:18px;font-weight:700}
        .cart-clear{color:var(--danger);font-size:13px;cursor:pointer;font-weight:600}
        .cart-body{flex:1;overflow-y:auto;padding:10px 15px}
        .cart-empty{text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-item{display:flex;gap:12px;padding:14px;background:#f9f9f9;border-radius:14px;margin-bottom:10px}
        .cart-item-img{width:55px;height:55px;border-radius:10px;object-fit:cover}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:14px;margin-bottom:3px}
        .cart-item-detail{font-size:11px;color:var(--text-light);line-height:1.4}
        .cart-item-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
        .cart-item-price{font-weight:700;color:var(--primary);font-size:15px}
        .cart-item-qty{display:flex;align-items:center;gap:8px;background:#fff;padding:4px;border-radius:10px}
        .cart-qty-btn{width:28px;height:28px;border:none;background:#f0f0f0;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer}
        .cart-qty-btn.delete{background:#ffe5e5;color:var(--danger)}
        .cart-item-num{font-weight:600;min-width:24px;text-align:center;font-size:14px}
        .cart-footer{padding:15px;border-top:1px solid var(--border)}
        .cart-summary{display:flex;justify-content:space-between;margin-bottom:12px;font-size:14px}
        .cart-summary-total{font-weight:700;font-size:18px;color:var(--primary)}
        .submit-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer}
        .submit-btn:disabled{opacity:.6}
        .loading{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
        @keyframes spin{to{transform:rotate(360deg)}}
        .logout-btn{position:fixed;bottom:100px;right:15px;background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.1);z-index:50}
        .compensate-section{margin-top:15px;padding:12px;background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border-radius:12px;border:2px solid var(--success)}
        .compensate-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .compensate-label{font-size:12px;font-weight:700;color:var(--success);text-transform:uppercase}
        .compensate-count{font-size:11px;color:var(--success);font-weight:600}
        .compensate-chips{display:flex;flex-wrap:wrap;gap:8px}
        .section-divider{grid-column:1/-1;padding:10px 5px 5px;font-size:13px;font-weight:700;color:var(--primary);border-bottom:2px solid var(--primary);margin-top:10px}
        .section-divider:first-child{margin-top:0}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <img src="/static/logo.png" class="login-logo" alt="Logo">
            <div class="login-title">KH·ªà MILKTEA</div>
            <div class="login-sub">Nh·∫≠p m√£ PIN ƒë·ªÉ ƒëƒÉng nh·∫≠p</div>
            <input type="tel" class="pin-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            <button class="login-btn" onclick="login()">ƒêƒÉng nh·∫≠p</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-top">
                <div><span class="order-num" id="orderNum">ƒê∆°n #001</span></div>
                <div class="brand">KH·ªà MILKTEA <img src="/static/logo.png" alt=""></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
                <input type="text" class="customer-input" id="customerName" placeholder="üë§ T√™n kh√°ch h√†ng..." style="flex:1">
                <span class="staff-name" onclick="logout()">üë§ <span id="staffDisplay">---</span> ‚úèÔ∏è</span>
            </div>
        </div>
        <div class="search-wrap">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input class="search-input" id="searchInput" placeholder="T√¨m m√≥n..." autocomplete="off">
                <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
            </div>
        </div>
        <div class="categories" id="categories"></div>
        <div class="products" id="products"></div>
        <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
        <div class="cart-bar" id="cartBar">
            <div class="cart-preview" onclick="openCartModal()">
                <div class="cart-badge" id="cartCount">0</div>
                <div class="cart-text"><div class="cart-label">Xem gi·ªè h√†ng</div><div class="cart-total" id="cartTotal">0ƒë</div></div>
            </div>
            <button class="cart-btn" onclick="openCartModal()">XEM ƒê∆†N</button>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toastText"></span></div>
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-product"><img class="modal-img" id="modalImg" src=""><div><div class="modal-name" id="modalName"></div><div class="modal-price" id="modalPrice"></div></div></div>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="qty-section"><div class="qty-label">S·ªë l∆∞·ª£ng</div><div class="qty-control"><button class="qty-btn" onclick="adjustQty(-1)">‚àí</button><span class="qty-num" id="modalQty">1</span><button class="qty-btn" onclick="adjustQty(1)">+</button></div></div>
                <div class="section-label">üìù Ghi ch√∫ nhanh</div>
                <div class="chips" id="noteChips"></div>
                <textarea class="custom-note" id="customNote" placeholder="Ghi ch√∫ th√™m (VD: √≠t ƒë∆∞·ªùng, th√™m kem...)"></textarea>
                <div class="topping-header" id="toppingLabel">
                    <div class="section-label" style="margin:0">üç° Topping <span class="section-hint">(Kh√¥ng ch·ªçn = Full)</span></div>
                    <div class="toggle-wrap"><span class="toggle-label">Lo·∫°i b·ªè</span><div class="toggle" id="excludeToggle" onclick="toggleExcludeMode()"></div></div>
                </div>
                <div class="chips" id="toppingChips"></div>
                <div class="compensate-section" id="compensateSection" style="display:none">
                    <div class="compensate-header">
                        <div class="compensate-label">‚úÖ B√π Topping</div>
                        <div class="compensate-count" id="compensateCount">ƒê√£ ch·ªçn 0/0</div>
                    </div>
                    <div class="compensate-chips" id="compensateChips"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="add-btn" onclick="addToCart()">TH√äM V√ÄO ƒê∆†N ¬∑ <span id="modalTotal">25,000ƒë</span></button></div>
        </div>
    </div>
    <div class="modal-overlay" id="cartModalOverlay" onclick="closeCartModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="cart-header"><div class="cart-title">üõí Gi·ªè h√†ng</div><div class="cart-clear" onclick="clearCart()">üóëÔ∏è X√≥a t·∫•t c·∫£</div></div>
            <div class="cart-body" id="cartBody"></div>
            <div class="cart-footer">
                <div class="cart-summary"><div>T·ªïng c·ªông</div><div class="cart-summary-total" id="cartSummaryTotal">0ƒë</div></div>
                <button class="submit-btn" id="submitBtn" onclick="submitOrder()">G·ª¨I B·∫æP üöÄ</button>
            </div>
        </div>
    </div>
<script>
const NOTES = ["√çt ƒë√°", "Kh√¥ng ƒë√°", "√çt ng·ªçt", "Nhi·ªÅu ng·ªçt", "Mang v·ªÅ"];
const TOPPINGS_BASIC = ["Tr√¢n Ch√¢u", "C·ªß NƒÉng", "Ph√¥ Mai", "Rau C√¢u", "Kh√∫c B·∫°ch", "S∆∞∆°ng S√°o", "Th·∫°ch ƒê√†o", "Flan Tr·ª©ng", "Ng·ªçc Trai", "Khoai D·∫ªo"];
const TOPPINGS_FRUIT = ["ƒê√°c Th∆°m", "ƒê√°c D√¢u T·∫±m", "Tr√°i C√¢y Nhi·ªát ƒê·ªõi", "T√°o Xanh", "D∆∞a L∆∞·ªõi", "·ªîi H·ªìng", "M√£ng C·∫ßu"];
const CATEGORIES = [
    {id:'trasua',name:'üßã Tr√† S·ªØa'},
    {id:'traicay',name:'üçπ Tr√† Tr√°i C√¢y'},
    {id:'macchiato',name:'ü•õ Macchiato'},
    {id:'dacbiet',name:'‚≠ê ƒê·∫∑c Bi·ªát'},
    {id:'topping',name:'üç° Topping Th√™m'},
    {id:'kotop',name:'üö´ KO TOP'}
];
const PRODUCTS = [
    {id:1,cat:'trasua',name:'Tr√† S·ªØa Truy·ªÅn Th·ªëng',price:25000,img:'/static/menu/ts-truyenthong.jpg'},
    {id:2,cat:'trasua',name:'Tr√† S·ªØa Matcha',price:25000,img:'/static/menu/ts-matcha.jpg'},
    {id:3,cat:'trasua',name:'Tr√† S·ªØa Caramel',price:25000,img:'/static/menu/ts-caramel.jpg'},
    {id:4,cat:'trasua',name:'Tr√† S·ªØa √î Long',price:25000,img:'/static/menu/ts-olong.jpg'},
    {id:5,cat:'trasua',name:'Tr√† S·ªØa Chocolate',price:25000,img:'/static/menu/ts-chocolate.jpg'},
    {id:6,cat:'trasua',name:'Tr√† S·ªØa ƒê√†o',price:25000,img:'/static/menu/ts-dao.jpg'},
    {id:10,cat:'traicay',name:'Tr√† ƒê√°c D√¢u T·∫±m',price:27000,img:'/static/menu/tc-dacdautam.jpg'},
    {id:11,cat:'traicay',name:'Tr√† ƒê√°c Th∆°m',price:27000,img:'/static/menu/tc-dacthom.jpg'},
    {id:12,cat:'traicay',name:'Tr√† ·ªîi H·ªìng',price:27000,img:'/static/menu/tc-oihong.jpg'},
    {id:13,cat:'traicay',name:'Tr√† Nhi·ªát ƒê·ªõi',price:27000,img:'/static/menu/tc-nhietdoi.jpg'},
    {id:14,cat:'traicay',name:'Tr√† T√°o Xanh',price:27000,img:'/static/menu/tc-taoxanh.jpg'},
    {id:15,cat:'traicay',name:'Tr√† D∆∞a L∆∞·ªõi',price:27000,img:'/static/menu/tc-dualuoi.jpg'},
    {id:16,cat:'traicay',name:'Tr√† M√£ng C·∫ßu',price:27000,img:'/static/menu/tc-mangcau.jpg'},
    {id:17,cat:'traicay',name:'Tr√† C√≥c H·∫°t ƒê√°c',price:27000,img:'/static/menu/tc-cochatdac.jpg'},
    {id:20,cat:'macchiato',name:'Tr√† ƒê√†o Macchiato',price:25000,img:'/static/menu/mc-dao.jpg'},
    {id:21,cat:'macchiato',name:'Tr√† D√¢u Macchiato',price:25000,img:'/static/menu/mc-dau.jpg'},
    {id:22,cat:'macchiato',name:'Tr√† V·∫£i Macchiato',price:25000,img:'/static/menu/mc-vai.jpg'},
    {id:23,cat:'macchiato',name:'H·ªìng Tr√† Macchiato',price:25000,img:'/static/menu/mc-hongtra.jpg'},
    {id:24,cat:'macchiato',name:'√î Long Macchiato',price:25000,img:'/static/menu/mc-olong.jpg'},
    {id:25,cat:'macchiato',name:'Tr√† Sen Macchiato',price:25000,img:'/static/menu/mc-sen.jpg'},
    {id:30,cat:'dacbiet',name:'Tr√† S·ªßi',price:25000,img:'/static/menu/db-trasui.jpg'},
    {id:31,cat:'dacbiet',name:'S·ªØa T∆∞∆°i Tr√¢n Ch√¢u ƒê.ƒê',price:27000,img:'/static/menu/db-suatuoi.jpg'},
    {id:32,cat:'dacbiet',name:'H·ªìng Tr√† Latte',price:27000,img:'/static/menu/db-hongtralatte.jpg'},
    {id:33,cat:'dacbiet',name:'Matcha Latte',price:27000,img:'/static/menu/db-matchalatte.jpg'},
    {id:100,cat:'topping',name:'Th√™m Tr√¢n Ch√¢u',price:5000,img:'/static/menu/tp-tranchau.jpg'},
    {id:101,cat:'topping',name:'Th√™m C·ªß NƒÉng',price:5000,img:'/static/menu/tp-cunang.jpg'},
    {id:102,cat:'topping',name:'Th√™m Ph√¥ Mai',price:5000,img:'/static/menu/tp-phomai.jpg'},
    {id:103,cat:'topping',name:'Th√™m Rau C√¢u',price:5000,img:'/static/menu/tp-raucau.jpg'},
    {id:104,cat:'topping',name:'Th√™m Kh√∫c B·∫°ch',price:5000,img:'/static/menu/tp-khucbach.jpg'},
    {id:105,cat:'topping',name:'Th√™m S∆∞∆°ng S√°o',price:5000,img:'/static/menu/tp-suongsao.jpg'},
    {id:106,cat:'topping',name:'Th√™m Th·∫°ch ƒê√†o',price:5000,img:'/static/menu/tp-thachdao.jpg'},
    {id:107,cat:'topping',name:'Th√™m Flan Tr·ª©ng',price:5000,img:'/static/menu/tp-flan.jpg'},
    {id:108,cat:'topping',name:'Th√™m Ng·ªçc Trai',price:5000,img:'/static/menu/tp-ngoctrai.jpg'},
    {id:109,cat:'topping',name:'Th√™m Khoai D·∫ªo',price:5000,img:'/static/menu/tp-khoaidao.jpg'},
    {id:110,cat:'topping',name:'Th√™m ƒê√°c Th∆°m',price:10000,img:'/static/menu/tp-dacthom.jpg'},
    {id:111,cat:'topping',name:'Th√™m ƒê√°c D√¢u T·∫±m',price:10000,img:'/static/menu/tp-dacdautam.jpg'},
    {id:112,cat:'topping',name:'Th√™m Tr√°i C√¢y Nhi·ªát ƒê·ªõi',price:10000,img:'/static/menu/tp-nhietdoi.jpg'},
    {id:113,cat:'topping',name:'Th√™m T√°o Xanh',price:10000,img:'/static/menu/tp-taoxanh.jpg'},
    {id:114,cat:'topping',name:'Th√™m D∆∞a L∆∞·ªõi',price:10000,img:'/static/menu/tp-dualuoi.jpg'},
    {id:115,cat:'topping',name:'Th√™m ·ªîi H·ªìng',price:10000,img:'/static/menu/tp-oihong.jpg'},
    {id:116,cat:'topping',name:'Th√™m M√£ng C·∫ßu',price:10000,img:'/static/menu/tp-mangcau.jpg'},
    // KO TOPPING
    {id:200,cat:'kotop',subcat:'trasua',name:'TS Truy·ªÅn Th·ªëng Ko Topping',price:19000,img:'/static/menu/ts-truyenthong.jpg'},
    {id:201,cat:'kotop',subcat:'trasua',name:'TS Matcha Ko Topping',price:19000,img:'/static/menu/ts-matcha.jpg'},
    {id:202,cat:'kotop',subcat:'trasua',name:'TS Caramel Ko Topping',price:19000,img:'/static/menu/ts-caramel.jpg'},
    {id:203,cat:'kotop',subcat:'trasua',name:'TS √î Long Ko Topping',price:19000,img:'/static/menu/ts-olong.jpg'},
    {id:204,cat:'kotop',subcat:'trasua',name:'TS Chocolate Ko Topping',price:19000,img:'/static/menu/ts-chocolate.jpg'},
    {id:205,cat:'kotop',subcat:'trasua',name:'TS ƒê√†o Ko Topping',price:19000,img:'/static/menu/ts-dao.jpg'},
    {id:210,cat:'kotop',subcat:'macchiato',name:'Tr√† ƒê√†o Ko Topping',price:19000,img:'/static/menu/mc-dao.jpg'},
    {id:211,cat:'kotop',subcat:'macchiato',name:'Tr√† D√¢u Ko Topping',price:19000,img:'/static/menu/mc-dau.jpg'},
    {id:212,cat:'kotop',subcat:'macchiato',name:'Tr√† V·∫£i Ko Topping',price:19000,img:'/static/menu/mc-vai.jpg'},
    {id:213,cat:'kotop',subcat:'macchiato',name:'H·ªìng Tr√† Ko Topping',price:19000,img:'/static/menu/mc-hongtra.jpg'},
    {id:214,cat:'kotop',subcat:'macchiato',name:'√î Long Ko Topping',price:19000,img:'/static/menu/mc-olong.jpg'},
    {id:215,cat:'kotop',subcat:'macchiato',name:'Tr√† Sen Ko Topping',price:19000,img:'/static/menu/mc-sen.jpg'},
    {id:220,cat:'kotop',subcat:'dacbiet',name:'Tr√† S·ªßi Ko Topping',price:19000,img:'/static/menu/db-trasui.jpg'},
    {id:221,cat:'kotop',subcat:'dacbiet',name:'H·ªìng Tr√† Latte Ko Topping',price:22000,img:'/static/menu/db-hongtralatte.jpg'},
    {id:222,cat:'kotop',subcat:'dacbiet',name:'Matcha Latte Ko Topping',price:22000,img:'/static/menu/db-matchalatte.jpg'},
    {id:230,cat:'kotop',subcat:'traicay',name:'Tr√† ƒê√°c D√¢u T·∫±m Ko Topping',price:19000,img:'/static/menu/tc-dacdautam.jpg'},
    {id:231,cat:'kotop',subcat:'traicay',name:'Tr√† ƒê√°c Th∆°m Ko Topping',price:19000,img:'/static/menu/tc-dacthom.jpg'},
    {id:232,cat:'kotop',subcat:'traicay',name:'Tr√† ·ªîi H·ªìng Ko Topping',price:19000,img:'/static/menu/tc-oihong.jpg'},
    {id:233,cat:'kotop',subcat:'traicay',name:'Tr√† Nhi·ªát ƒê·ªõi Ko Topping',price:19000,img:'/static/menu/tc-nhietdoi.jpg'},
    {id:234,cat:'kotop',subcat:'traicay',name:'Tr√† T√°o Xanh Ko Topping',price:19000,img:'/static/menu/tc-taoxanh.jpg'},
    {id:235,cat:'kotop',subcat:'traicay',name:'Tr√† D∆∞a L∆∞·ªõi Ko Topping',price:19000,img:'/static/menu/tc-dualuoi.jpg'},
    {id:236,cat:'kotop',subcat:'traicay',name:'Tr√† M√£ng C·∫ßu Ko Topping',price:19000,img:'/static/menu/tc-mangcau.jpg'},
    {id:237,cat:'kotop',subcat:'traicay',name:'Tr√† C√≥c H·∫°t ƒê√°c Ko Topping',price:19000,img:'/static/menu/tc-cochatdac.jpg'}
];

let cart=[],currentItem=null,currentCat='trasua',excludeMode=false,searchQuery='',staffInfo=null;
let currentToppings=[];
let excludedList=[];
let compensateList=[];
const orderId=Math.floor(Math.random()*900)+100;
document.getElementById('orderNum').textContent='ƒê∆°n #'+orderId;

async function login(){
    const pin=document.getElementById('pinInput').value;
    if(pin.length!==4){document.getElementById('loginError').textContent='Vui l√≤ng nh·∫≠p 4 s·ªë';return;}
    try{
        const res=await fetch('/api/verify_pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin})});
        const data=await res.json();
        if(data.success){staffInfo=data.staff;localStorage.setItem('khi_pin',pin);showApp();}
        else{document.getElementById('loginError').textContent=data.message;document.getElementById('pinInput').classList.add('error');setTimeout(()=>document.getElementById('pinInput').classList.remove('error'),300);}
    }catch(e){document.getElementById('loginError').textContent='L·ªói k·∫øt n·ªëi!';}
}
function logout(){localStorage.removeItem('khi_pin');staffInfo=null;document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('appContainer').classList.remove('active');document.getElementById('pinInput').value='';document.getElementById('loginError').textContent='';}
function showApp(){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('appContainer').classList.add('active');document.getElementById('staffDisplay').textContent=staffInfo.name;initApp();}
async function checkAuth(){
    const pin=localStorage.getItem('khi_pin');
    if(pin){try{const res=await fetch('/api/verify_pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin})});const data=await res.json();if(data.success){staffInfo=data.staff;showApp();return;}}catch(e){}}
}
function initApp(){
    document.getElementById('categories').innerHTML=CATEGORIES.map((c,i)=>`<button class="cat-btn${i===0?' active':''}" onclick="selectCat('${c.id}',this)">${c.name}</button>`).join('');
    renderProducts();
}
const searchInput=document.getElementById('searchInput'),searchClear=document.getElementById('searchClear');
searchInput.addEventListener('input',e=>{searchQuery=e.target.value.toLowerCase().trim();searchClear.classList.toggle('show',searchQuery.length>0);renderProducts();});
function clearSearch(){searchInput.value='';searchQuery='';searchClear.classList.remove('show');renderProducts();}
function selectCat(id,btn){currentCat=id;document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');clearSearch();renderProducts();}

function renderProducts(){
    const container=document.getElementById('products');
    if(searchQuery){
        const filtered=PRODUCTS.filter(p=>p.name.toLowerCase().includes(searchQuery));
        if(!filtered.length){container.innerHTML='<div class="no-results">Kh√¥ng t√¨m th·∫•y</div>';return;}
        container.innerHTML=filtered.map(p=>`<div class="product-card" onclick="openModal(${p.id})"><img class="prod-img" src="/static/logo.png" data-src="${p.img}" loading="lazy"><div class="prod-info"><div class="prod-name">${p.name}</div><div class="prod-price">${p.price.toLocaleString()}ƒë</div></div></div>`).join('');
        lazyLoad();return;
    }
    if(currentCat==='kotop'){
        const sections=[{subcat:'trasua',title:'üßã TR√Ä S·ªÆA'},{subcat:'macchiato',title:'ü•õ MACCHIATO'},{subcat:'dacbiet',title:'‚≠ê ƒê·∫∂C BI·ªÜT'},{subcat:'traicay',title:'üçπ TR√Ä TR√ÅI C√ÇY'}];
        let html='';
        sections.forEach(s=>{const items=PRODUCTS.filter(p=>p.cat==='kotop'&&p.subcat===s.subcat);if(items.length){html+=`<div class="section-divider">${s.title}</div>`;html+=items.map(p=>`<div class="product-card" onclick="openModal(${p.id})"><img class="prod-img" src="/static/logo.png" data-src="${p.img}" loading="lazy"><div class="prod-info"><div class="prod-name">${p.name}</div><div class="prod-price">${p.price.toLocaleString()}ƒë</div></div></div>`).join('');}});
        container.innerHTML=html;lazyLoad();return;
    }
    const filtered=PRODUCTS.filter(p=>p.cat===currentCat);
    if(!filtered.length){container.innerHTML='<div class="no-results">Kh√¥ng t√¨m th·∫•y</div>';return;}
    container.innerHTML=filtered.map(p=>`<div class="product-card" onclick="openModal(${p.id})"><img class="prod-img" src="/static/logo.png" data-src="${p.img}" loading="lazy"><div class="prod-info"><div class="prod-name">${p.name}</div><div class="prod-price">${p.price.toLocaleString()}ƒë</div></div></div>`).join('');
    lazyLoad();
}
function lazyLoad(){requestAnimationFrame(()=>{document.querySelectorAll('.prod-img[data-src]').forEach(img=>{const src=img.dataset.src;const n=new Image();n.onload=()=>{img.src=src;img.classList.add('loaded');};n.onerror=()=>{img.src='/static/logo.png';img.classList.add('loaded');};n.src=src;});});}

function openModal(id){
    const p=PRODUCTS.find(x=>x.id===id);
    // tops gi·ªù l√† array of objects {name, price}
    currentItem={...p,qty:1,tops:[],notes:[],customNote:''};
    excludeMode=false;
    excludedList=[];
    compensateList=[];
    document.getElementById('modalImg').src=p.img;document.getElementById('modalImg').onerror=function(){this.src='/static/logo.png';};
    document.getElementById('modalName').textContent=p.name;document.getElementById('modalPrice').textContent=p.price.toLocaleString()+'ƒë';
    document.getElementById('modalQty').textContent=1;document.getElementById('customNote').value='';
    document.getElementById('noteChips').innerHTML=NOTES.map(n=>`<div class="chip chip-note" onclick="toggleNote(this,'${n}')">${n}</div>`).join('');
    let toppings=[],label=document.getElementById('toppingLabel');
    if(p.cat==='traicay'){toppings=TOPPINGS_FRUIT;label.style.display='flex';}
    else if(p.cat==='topping'||p.cat==='kotop'){label.style.display='none';document.getElementById('toppingChips').innerHTML='';}
    else{toppings=TOPPINGS_BASIC;label.style.display='flex';}
    currentToppings=toppings;
    document.getElementById('excludeToggle').classList.remove('active');
    document.getElementById('compensateSection').style.display='none';
    if(toppings.length)document.getElementById('toppingChips').innerHTML=toppings.map(t=>`<div class="chip" onclick="toggleTopping(this,'${t}')">${t}</div>`).join('');
    updateModalTotal();document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(e){if(!e||e.target.id==='modalOverlay'||e.target.classList.contains('modal-close'))document.getElementById('modalOverlay').classList.remove('show');}
function adjustQty(d){if(currentItem.qty+d>0){currentItem.qty+=d;document.getElementById('modalQty').textContent=currentItem.qty;updateModalTotal();}}
function toggleNote(el,note){el.classList.toggle('active');currentItem.notes=el.classList.contains('active')?[...currentItem.notes,note]:currentItem.notes.filter(n=>n!==note);}

function toggleExcludeMode(){
    excludeMode=!excludeMode;
    document.getElementById('excludeToggle').classList.toggle('active',excludeMode);
    document.querySelectorAll('#toppingChips .chip').forEach(chip=>{chip.classList.toggle('exclude',excludeMode);chip.classList.remove('active');});
    currentItem.tops=[];
    excludedList=[];
    compensateList=[];
    document.getElementById('compensateSection').style.display='none';
}

function toggleTopping(el,name){
    el.classList.toggle('active');
    if(excludeMode){
        // Ch·∫ø ƒë·ªô lo·∫°i b·ªè - l∆∞u d·∫°ng object {name, price:0}
        if(el.classList.contains('active')){
            excludedList.push(name);
            currentItem.tops.push({name:'Kh√¥ng '+name,price:0});
        }else{
            excludedList=excludedList.filter(t=>t!==name);
            currentItem.tops=currentItem.tops.filter(t=>t.name!=='Kh√¥ng '+name);
            // Gi·∫£m compensate n·∫øu v∆∞·ª£t qu√°
            while(compensateList.length>excludedList.length){
                const removed=compensateList.pop();
                currentItem.tops=currentItem.tops.filter(t=>t.name!=='B√π '+removed);
            }
        }
        // Show/hide compensate section
        if(excludedList.length>0){
            document.getElementById('compensateSection').style.display='block';
            renderCompensateChips();
        }else{
            document.getElementById('compensateSection').style.display='none';
        }
    }else{
        // Ch·∫ø ƒë·ªô b√¨nh th∆∞·ªùng - l∆∞u d·∫°ng object {name, price:0}
        if(el.classList.contains('active')){
            currentItem.tops.push({name:name,price:0});
        }else{
            currentItem.tops=currentItem.tops.filter(t=>t.name!==name);
        }
    }
}

function renderCompensateChips(){
    const container=document.getElementById('compensateChips');
    const max=excludedList.length;
    const cur=compensateList.length;
    const avail=currentToppings.filter(t=>!excludedList.includes(t));
    container.innerHTML=avail.map(t=>{
        let cls='chip compensate';
        const sel=compensateList.includes(t);
        const dis=!sel&&cur>=max;
        if(sel)cls+=' active';
        if(dis)cls+=' disabled';
        return `<div class="${cls}" onclick="toggleCompensate(this,'${t}')">${t}</div>`;
    }).join('');
    document.getElementById('compensateCount').textContent=`ƒê√£ ch·ªçn ${cur}/${max}`;
}

function toggleCompensate(el,name){
    if(el.classList.contains('disabled'))return;
    if(compensateList.includes(name)){
        compensateList=compensateList.filter(t=>t!==name);
        currentItem.tops=currentItem.tops.filter(t=>t.name!=='B√π '+name);
    }else{
        if(compensateList.length<excludedList.length){
            compensateList.push(name);
            currentItem.tops.push({name:'B√π '+name,price:0});
        }
    }
    renderCompensateChips();
}

function updateModalTotal(){document.getElementById('modalTotal').textContent=(currentItem.price*currentItem.qty).toLocaleString()+'ƒë';}

function addToCart(){currentItem.customNote=document.getElementById('customNote').value.trim();cart.push({...currentItem,cartId:Date.now()});document.getElementById('modalOverlay').classList.remove('show');updateCartBar();showToast('ƒê√£ th√™m v√†o gi·ªè');}

function showToast(text){const toast=document.getElementById('toast');document.getElementById('toastText').textContent=text;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000);}
function updateCartBar(){const bar=document.getElementById('cartBar');if(cart.length>0){bar.classList.add('show');document.getElementById('cartCount').textContent=cart.reduce((s,i)=>s+i.qty,0);document.getElementById('cartTotal').textContent=cart.reduce((s,i)=>s+(i.price*i.qty),0).toLocaleString()+'ƒë';}else{bar.classList.remove('show');}}
function openCartModal(){renderCartItems();document.getElementById('cartModalOverlay').classList.add('show');}
function closeCartModal(e){if(!e||e.target.id==='cartModalOverlay')document.getElementById('cartModalOverlay').classList.remove('show');}
function renderCartItems(){
    const body=document.getElementById('cartBody');
    if(!cart.length){body.innerHTML='<div class="cart-empty">üõí Gi·ªè h√†ng tr·ªëng</div>';document.getElementById('cartSummaryTotal').textContent='0ƒë';return;}
    body.innerHTML=cart.map((item,i)=>{
        let d=[];
        if(item.notes.length)d.push(item.notes.join(', '));
        // tops gi·ªù l√† array of objects, l·∫•y name ƒë·ªÉ hi·ªÉn th·ªã
        if(item.tops.length)d.push(item.tops.map(t=>t.name).join(', '));
        if(item.customNote)d.push('üìù '+item.customNote);
        return '<div class="cart-item"><img class="cart-item-img" src="'+item.img+'" onerror="this.src=\'/static/logo.png\'"><div class="cart-item-info"><div class="cart-item-name">'+item.name+'</div>'+(d.length?'<div class="cart-item-detail">'+d.join(' ‚Ä¢ ')+'</div>':'')+'<div class="cart-item-bottom"><div class="cart-item-price">'+(item.price*item.qty).toLocaleString()+'ƒë</div><div class="cart-item-qty"><button class="cart-qty-btn '+(item.qty===1?'delete':'')+'" onclick="updateCartItem('+i+',-1)">'+(item.qty===1?'üóëÔ∏è':'‚àí')+'</button><span class="cart-item-num">'+item.qty+'</span><button class="cart-qty-btn" onclick="updateCartItem('+i+',1)">+</button></div></div></div></div>';
    }).join('');
    document.getElementById('cartSummaryTotal').textContent=cart.reduce((s,i)=>s+(i.price*i.qty),0).toLocaleString()+'ƒë';
}
function updateCartItem(i,d){if(cart[i].qty+d<=0)cart.splice(i,1);else cart[i].qty+=d;renderCartItems();updateCartBar();}
function clearCart(){if(cart.length&&confirm('X√≥a t·∫•t c·∫£?')){cart=[];renderCartItems();updateCartBar();}}

async function submitOrder(){
    if(!cart.length)return showToast('Gi·ªè h√†ng tr·ªëng!');
    const pin=localStorage.getItem('khi_pin');if(!pin||!staffInfo){showToast('Phi√™n h·∫øt h·∫°n!');logout();return;}
    
    // Format data theo ƒë√∫ng OrderData schema
    // tops: List[ToppingItem] = [{name: str, price: int}]
    const data={
        order_id:'KHI'+orderId,
        customer:document.getElementById('customerName').value||'Kh√°ch l·∫ª',
        staff_name:staffInfo.name,
        staff_pin:pin,
        items:cart.map(i=>({
            name:i.name,
            price:i.price,
            qty:i.qty,
            tops:i.tops, // ƒë√£ l√† array of {name, price}
            notes:i.customNote?[...i.notes,i.customNote]:i.notes
        })),
        total:cart.reduce((s,i)=>s+(i.price*i.qty),0)
    };
    
    const btn=document.getElementById('submitBtn');btn.innerHTML='<span class="loading"></span>ƒêang g·ª≠i...';btn.disabled=true;
    try{
        const res=await fetch('/api/submit_order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const result=await res.json();
        if(result.success){showToast('‚úÖ ƒê√£ g·ª≠i order!');cart=[];updateCartBar();document.getElementById('cartModalOverlay').classList.remove('show');document.getElementById('customerName').value='';document.getElementById('orderNum').textContent='ƒê∆°n #'+(Math.floor(Math.random()*900)+100);}
        else{showToast('‚ùå '+result.message);}
    }catch(err){showToast('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi!');}
    btn.innerHTML='G·ª¨I B·∫æP üöÄ';btn.disabled=false;
}
checkAuth();
</script>
</body>
</html>
