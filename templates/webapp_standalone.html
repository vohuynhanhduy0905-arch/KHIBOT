<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order - KH·ªà MILKTEA</title>
    <meta name="theme-color" content="#1A5336">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{--primary:#1A5336;--primary-light:#2d7a4e;--bg:#FDF8F3;--text:#333;--text-light:#666;--border:#e8e0d8;--danger:#e74c3c}
        body{background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:var(--text);min-height:100vh}
        .login-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
        .login-screen.hidden{display:none}
        .login-box{background:#fff;padding:30px;border-radius:20px;text-align:center;width:100%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
        .login-logo{width:80px;height:80px;margin-bottom:15px;border-radius:12px}
        .login-title{font-size:22px;font-weight:700;color:var(--primary);margin-bottom:5px}
        .login-sub{font-size:13px;color:var(--text-light);margin-bottom:25px}
        .pin-input{width:100%;padding:15px;font-size:24px;text-align:center;border:2px solid var(--border);border-radius:12px;letter-spacing:10px;font-weight:700;outline:none}
        .pin-input:focus{border-color:var(--primary)}
        .pin-input.error{border-color:var(--danger);animation:shake .3s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .login-btn{width:100%;padding:15px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;margin-top:15px;cursor:pointer}
        .login-btn:disabled{background:#ccc}
        .login-error{color:var(--danger);font-size:13px;margin-top:10px;display:none}
        .login-hint{font-size:11px;color:var(--text-light);margin-top:15px;line-height:1.5}
        .app-container{display:none;padding-bottom:90px}
        .app-container.active{display:block}
        .header{background:var(--primary);color:#fff;padding:10px 15px;position:sticky;top:0;z-index:100}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .order-num{font-size:11px;opacity:.8}
        .brand{font-weight:700;font-size:14px;display:flex;align-items:center;gap:6px;justify-content:flex-end}
        .brand img{width:24px;height:24px;border-radius:4px}
        .staff-name{font-size:11px;opacity:.8;text-align:right}
        .customer-input{width:100%;background:rgba(255,255,255,.15);border:none;color:#fff;padding:8px 12px;border-radius:8px;font-size:14px;outline:none}
        .customer-input::placeholder{color:rgba(255,255,255,.6)}
        .categories{display:flex;overflow-x:auto;padding:10px 15px;gap:8px;background:#fff;border-bottom:1px solid var(--border)}
        .categories::-webkit-scrollbar{display:none}
        .cat-btn{flex-shrink:0;padding:8px 14px;border-radius:20px;border:1.5px solid var(--border);background:#fff;color:var(--text-light);font-size:12px;font-weight:600;cursor:pointer}
        .cat-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .products{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px}
        .product-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05);cursor:pointer;border:1px solid var(--border)}
        .product-card:active{transform:scale(.96)}
        .prod-img{width:100%;aspect-ratio:1;object-fit:cover;background:#f5f5f5}
        .prod-info{padding:8px;text-align:center}
        .prod-name{font-size:11px;font-weight:600;line-height:1.3;height:28px;overflow:hidden}
        .prod-price{font-size:12px;font-weight:700;color:var(--primary);margin-top:2px}
        .cart-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:10px 15px;display:none;align-items:center;box-shadow:0 -4px 20px rgba(0,0,0,.1);z-index:100;gap:10px}
        .cart-bar.show{display:flex}
        .cart-preview{flex:1;display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px;background:#f9f9f9;border-radius:10px}
        .cart-badge{background:var(--primary);color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px}
        .cart-text{flex:1}
        .cart-label{font-size:11px;color:var(--text-light)}
        .cart-total{font-size:16px;font-weight:700;color:var(--primary)}
        .cart-btn{background:var(--primary);color:#fff;border:none;padding:14px 20px;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end}
        .modal-overlay.show{display:flex}
        .modal{background:#fff;width:100%;max-height:90vh;border-radius:20px 20px 0 0;display:flex;flex-direction:column;animation:slideUp .3s ease}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-close{width:32px;height:32px;border:none;background:#f0f0f0;border-radius:50%;font-size:18px;cursor:pointer}
        .modal-product{display:flex;align-items:center;gap:12px;flex:1}
        .modal-img{width:50px;height:50px;border-radius:8px;object-fit:cover}
        .modal-name{font-size:16px;font-weight:700}
        .modal-price{font-size:14px;color:var(--primary);font-weight:600}
        .modal-body{padding:15px;overflow-y:auto;flex:1}
        .qty-section{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f9f9f9;border-radius:12px;margin-bottom:15px}
        .qty-label{font-weight:600}
        .qty-control{display:flex;align-items:center;gap:15px}
        .qty-btn{width:36px;height:36px;border:none;background:#fff;border-radius:10px;font-size:20px;font-weight:700;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .qty-num{font-size:18px;font-weight:700;min-width:30px;text-align:center}
        .section-label{font-size:12px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin:15px 0 10px}
        .section-hint{font-weight:400;font-size:11px;color:#999}
        .topping-header{display:flex;justify-content:space-between;align-items:center;margin:15px 0 10px}
        .toggle-wrap{display:flex;align-items:center;gap:8px}
        .toggle-label{font-size:11px;color:var(--text-light)}
        .toggle{position:relative;width:44px;height:24px;background:#ddd;border-radius:12px;cursor:pointer}
        .toggle.active{background:#e74c3c}
        .toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .2s}
        .toggle.active::after{transform:translateX(20px)}
        .chip.exclude{border-color:#e74c3c;color:#e74c3c}
        .chip.exclude.active{background:#e74c3c;color:#fff;border-color:#e74c3c}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .chip{padding:8px 12px;border:1.5px solid var(--border);border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;background:#fff}
        .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chip-note.active{background:#555;border-color:#555}
        .custom-note{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;font-size:13px;margin-top:10px;outline:none;resize:none;font-family:inherit}
        .custom-note:focus{border-color:var(--primary)}
        .modal-footer{padding:15px;border-top:1px solid var(--border)}
        .add-btn{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer}
        .cart-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .cart-title{font-size:18px;font-weight:700}
        .cart-clear{color:var(--danger);font-size:13px;cursor:pointer}
        .cart-body{flex:1;overflow-y:auto;padding:10px 15px}
        .cart-empty{text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-item{display:flex;gap:10px;padding:12px;background:#f9f9f9;border-radius:12px;margin-bottom:10px}
        .cart-item-img{width:50px;height:50px;border-radius:8px;object-fit:cover}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:14px;margin-bottom:2px}
        .cart-item-detail{font-size:11px;color:var(--text-light);line-height:1.4}
        .cart-item-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:5px}
        .cart-item-price{font-weight:700;color:var(--primary);font-size:14px}
        .cart-item-qty{display:flex;align-items:center;gap:8px;background:#fff;padding:4px;border-radius:8px}
        .cart-qty-btn{width:26px;height:26px;border:none;background:#eee;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer}
        .cart-qty-btn.delete{background:#ffe5e5;color:var(--danger)}
        .cart-item-num{font-weight:600;min-width:20px;text-align:center}
        .cart-footer{padding:15px;border-top:1px solid var(--border)}
        .cart-summary{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .cart-summary-label{font-size:14px;color:var(--text-light)}
        .cart-summary-value{font-size:22px;font-weight:800;color:var(--primary)}
        .submit-btn{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer}
        .submit-btn:disabled{background:#ccc}
        .logout-btn{position:fixed;top:60px;right:10px;background:rgba(0,0,0,.3);color:#fff;border:none;padding:6px 10px;border-radius:15px;font-size:10px;cursor:pointer;z-index:99}
        .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <img src="/static/logo.png" class="login-logo" alt="Logo">
        <div class="login-title">KH·ªà MILKTEA</div>
        <div class="login-sub">Nh·∫≠p m√£ PIN ƒë·ªÉ ƒëƒÉng nh·∫≠p</div>
        <input type="password" class="pin-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
        <div class="login-error" id="loginError"></div>
        <button class="login-btn" id="loginBtn" onclick="checkPin()">V√ÄO ·ª®NG D·ª§NG</button>
        <div class="login-hint">üí° Ch∆∞a c√≥ PIN? M·ªü Bot v√† g·ª≠i:<br><b>/dangky T√™nB·∫°n SƒêT</b></div>
    </div>
</div>
<div class="app-container" id="appContainer">
    <div class="header">
        <div class="header-top">
            <div><div class="order-num">ƒê∆°n #<span id="orderId">000</span></div></div>
            <div class="header-right">
                <div class="brand">KH·ªà MILKTEA <img src="/static/logo.png" alt=""></div>
                <div class="staff-name">üë§ <span id="staffDisplay">---</span></div>
            </div>
        </div>
        <input type="text" class="customer-input" id="customerName" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng...">
    </div>
    <div class="categories" id="categories"></div>
    <div class="products" id="products"></div>
    <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    <div class="cart-bar" id="cartBar">
        <div class="cart-preview" onclick="openCartModal()">
            <div class="cart-badge" id="cartBadge">0</div>
            <div class="cart-text"><div class="cart-label">Xem gi·ªè h√†ng</div><div class="cart-total" id="cartTotal">0ƒë</div></div>
            <span style="color:var(--text-light)">‚Ä∫</span>
        </div>
        <button class="cart-btn" onclick="openCartModal()">XEM ƒê∆†N</button>
    </div>
</div>
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-product">
                <img class="modal-img" id="modalImg" src="">
                <div><div class="modal-name" id="modalName"></div><div class="modal-price" id="modalPrice"></div></div>
            </div>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="qty-section">
                <div class="qty-label">S·ªë l∆∞·ª£ng</div>
                <div class="qty-control">
                    <button class="qty-btn" onclick="adjustQty(-1)">‚àí</button>
                    <span class="qty-num" id="modalQty">1</span>
                    <button class="qty-btn" onclick="adjustQty(1)">+</button>
                </div>
            </div>
            <div class="section-label">üìù Ghi ch√∫ nhanh</div>
            <div class="chips" id="noteChips"></div>
            <textarea class="custom-note" id="customNote" placeholder="Ghi ch√∫ th√™m..."></textarea>
            <div class="topping-header" id="toppingLabel">
                <div class="section-label" style="margin:0">üç° Topping <span class="section-hint">(Kh√¥ng ch·ªçn = Full)</span></div>
                <div class="toggle-wrap"><span class="toggle-label">Lo·∫°i b·ªè</span><div class="toggle" id="excludeToggle" onclick="toggleExcludeMode()"></div></div>
            </div>
            <div class="chips" id="toppingChips"></div>
        </div>
        <div class="modal-footer">
            <button class="add-btn" onclick="addToCart()">TH√äM V√ÄO ƒê∆†N ‚Ä¢ <span id="modalTotal">0ƒë</span></button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="cartModalOverlay" onclick="closeCartModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="cart-header"><div class="cart-title">üõí Gi·ªè h√†ng</div><div class="cart-clear" onclick="clearCart()">üóëÔ∏è X√≥a t·∫•t c·∫£</div></div>
        <div class="cart-body" id="cartBody"></div>
        <div class="cart-footer">
            <div class="cart-summary"><div class="cart-summary-label">T·ªïng c·ªông</div><div class="cart-summary-value" id="cartSummaryTotal">0ƒë</div></div>
            <button class="submit-btn" id="submitBtn" onclick="submitOrder()">G·ª¨I B·∫æP üöÄ</button>
        </div>
    </div>
</div>
<script>
const NOTES=["√çt ƒë√°","Kh√¥ng ƒë√°","√çt ng·ªçt","Nhi·ªÅu ng·ªçt","Mang v·ªÅ"];
const TOPPINGS_BASIC=["Tr√¢n Ch√¢u","C·ªß NƒÉng","Ph√¥ Mai","Rau C√¢u","Kh√∫c B·∫°ch","S∆∞∆°ng S√°o","Th·∫°ch ƒê√†o","Flan Tr·ª©ng","Ng·ªçc Trai","Khoai D·∫ªo"];
const TOPPINGS_FRUIT=["ƒê√°c Th∆°m","ƒê√°c D√¢u T·∫±m","Tr√°i C√¢y Nhi·ªát ƒê·ªõi","T√°o Xanh","D∆∞a L∆∞·ªõi","·ªîi H·ªìng","M√£ng C·∫ßu"];
const CATEGORIES=[{id:'trasua',name:'üßã Tr√† S·ªØa'},{id:'traicay',name:'üçπ Tr√† Tr√°i C√¢y'},{id:'macchiato',name:'ü•õ Macchiato'},{id:'dacbiet',name:'‚≠ê ƒê·∫∑c Bi·ªát'},{id:'topping',name:'üç° Topping Th√™m'}];
const PRODUCTS=[
{id:1,cat:'trasua',name:'Tr√† S·ªØa Truy·ªÅn Th·ªëng',price:25000,img:'/static/menu/ts-truyenthong.jpg'},
{id:2,cat:'trasua',name:'Tr√† S·ªØa Matcha',price:25000,img:'/static/menu/ts-matcha.jpg'},
{id:3,cat:'trasua',name:'Tr√† S·ªØa Caramel',price:25000,img:'/static/menu/ts-caramel.jpg'},
{id:4,cat:'trasua',name:'Tr√† S·ªØa √î Long',price:25000,img:'/static/menu/ts-olong.jpg'},
{id:5,cat:'trasua',name:'Tr√† S·ªØa Chocolate',price:25000,img:'/static/menu/ts-chocolate.jpg'},
{id:6,cat:'trasua',name:'Tr√† S·ªØa ƒê√†o',price:25000,img:'/static/menu/ts-dao.jpg'},
{id:10,cat:'traicay',name:'Tr√† ƒê√°c D√¢u T·∫±m',price:27000,img:'/static/menu/tc-dacdautam.jpg'},
{id:11,cat:'traicay',name:'Tr√† ƒê√°c Th∆°m',price:27000,img:'/static/menu/tc-dacthom.jpg'},
{id:12,cat:'traicay',name:'Tr√† ·ªîi H·ªìng',price:27000,img:'/static/menu/tc-oihong.jpg'},
{id:13,cat:'traicay',name:'Tr√† Nhi·ªát ƒê·ªõi',price:27000,img:'/static/menu/tc-nhietdoi.jpg'},
{id:14,cat:'traicay',name:'Tr√† T√°o Xanh',price:27000,img:'/static/menu/tc-taoxanh.jpg'},
{id:15,cat:'traicay',name:'Tr√† D∆∞a L∆∞·ªõi',price:27000,img:'/static/menu/tc-dualuoi.jpg'},
{id:16,cat:'traicay',name:'Tr√† M√£ng C·∫ßu',price:27000,img:'/static/menu/tc-mangcau.jpg'},
{id:17,cat:'traicay',name:'Tr√† C√≥c H·∫°t ƒê√°c',price:27000,img:'/static/menu/tc-cochatdac.jpg'},
{id:20,cat:'macchiato',name:'Tr√† ƒê√†o Macchiato',price:25000,img:'/static/menu/mc-dao.jpg'},
{id:21,cat:'macchiato',name:'Tr√† D√¢u Macchiato',price:25000,img:'/static/menu/mc-dau.jpg'},
{id:22,cat:'macchiato',name:'Tr√† V·∫£i Macchiato',price:25000,img:'/static/menu/mc-vai.jpg'},
{id:23,cat:'macchiato',name:'H·ªìng Tr√† Macchiato',price:25000,img:'/static/menu/mc-hongtra.jpg'},
{id:24,cat:'macchiato',name:'√î Long Macchiato',price:25000,img:'/static/menu/mc-olong.jpg'},
{id:25,cat:'macchiato',name:'Tr√† Sen Macchiato',price:25000,img:'/static/menu/mc-sen.jpg'},
{id:30,cat:'dacbiet',name:'Tr√† S·ªßi',price:25000,img:'/static/menu/db-trasui.jpg'},
{id:31,cat:'dacbiet',name:'S·ªØa T∆∞∆°i Tr√¢n Ch√¢u ƒê.ƒê',price:27000,img:'/static/menu/db-suatuoi.jpg'},
{id:32,cat:'dacbiet',name:'H·ªìng Tr√† Latte',price:27000,img:'/static/menu/db-hongtralatte.jpg'},
{id:33,cat:'dacbiet',name:'Matcha Latte',price:27000,img:'/static/menu/db-matchalatte.jpg'},
{id:100,cat:'topping',name:'Th√™m Tr√¢n Ch√¢u',price:5000,img:'/static/menu/tp-tranchau.jpg'},
{id:101,cat:'topping',name:'Th√™m Ph√¥ Mai',price:5000,img:'/static/menu/tp-phomai.jpg'},
{id:102,cat:'topping',name:'Th√™m Flan',price:5000,img:'/static/menu/tp-flan.jpg'},
{id:103,cat:'topping',name:'Th√™m ƒê√°c Th∆°m',price:10000,img:'/static/menu/tp-dacthom.jpg'},
{id:104,cat:'topping',name:'Th√™m ƒê√°c D√¢u T·∫±m',price:10000,img:'/static/menu/tp-dacdautam.jpg'},
{id:105,cat:'topping',name:'Th√™m ·ªîi H·ªìng',price:10000,img:'/static/menu/tp-oihong.jpg'},
{id:106,cat:'topping',name:'Th√™m M√£ng C·∫ßu',price:10000,img:'/static/menu/tp-mangcau.jpg'}];
let cart=[],currentItem=null,currentCat='trasua',excludeMode=false,staffInfo=null;

async function checkPin(){
    const pin=document.getElementById('pinInput').value,input=document.getElementById('pinInput'),error=document.getElementById('loginError'),btn=document.getElementById('loginBtn');
    if(pin.length<4){input.classList.add('error');error.textContent='‚ùå Nh·∫≠p ƒë·ªß 4 s·ªë!';error.style.display='block';setTimeout(()=>input.classList.remove('error'),300);return;}
    btn.disabled=true;btn.textContent='ƒêang ki·ªÉm tra...';
    try{
        const res=await fetch('/api/verify_pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin})});
        const result=await res.json();
        if(result.success){staffInfo=result.staff;localStorage.setItem('khi_pin',pin);localStorage.setItem('khi_staff',JSON.stringify(staffInfo));showApp();}
        else{input.classList.add('error');error.textContent='‚ùå '+result.message;error.style.display='block';setTimeout(()=>{input.classList.remove('error');input.value='';},300);}
    }catch(err){error.textContent='‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server!';error.style.display='block';}
    btn.disabled=false;btn.textContent='V√ÄO ·ª®NG D·ª§NG';
}
function showApp(){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('appContainer').classList.add('active');initApp();}
function logout(){if(confirm('ƒêƒÉng xu·∫•t?')){localStorage.removeItem('khi_pin');localStorage.removeItem('khi_staff');location.reload();}}
function checkAuth(){const p=localStorage.getItem('khi_pin'),s=localStorage.getItem('khi_staff');if(p&&s){try{staffInfo=JSON.parse(s);showApp();}catch{localStorage.clear();}}}
document.getElementById('pinInput').addEventListener('keyup',e=>{if(e.key==='Enter')checkPin();});

function initApp(){
    document.getElementById('orderId').textContent=Math.floor(Math.random()*900)+100;
    document.getElementById('staffDisplay').textContent=staffInfo?staffInfo.name:'---';
    document.getElementById('categories').innerHTML=CATEGORIES.map(c=>'<button class="cat-btn '+(c.id===currentCat?'active':'')+'" onclick="selectCat(\''+c.id+'\',this)">'+c.name+'</button>').join('');
    renderProducts();
}
function selectCat(id,btn){currentCat=id;document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderProducts();}
function renderProducts(){document.getElementById('products').innerHTML=PRODUCTS.filter(p=>p.cat===currentCat).map(p=>'<div class="product-card" onclick="openModal('+p.id+')"><img class="prod-img" src="'+p.img+'" onerror="this.style.background=\'#eee\'"><div class="prod-info"><div class="prod-name">'+p.name+'</div><div class="prod-price">'+p.price.toLocaleString()+'ƒë</div></div></div>').join('');}

function openModal(id){
    const p=PRODUCTS.find(x=>x.id===id);currentItem={...p,qty:1,tops:[],notes:[],customNote:''};
    document.getElementById('modalImg').src=p.img;document.getElementById('modalName').textContent=p.name;document.getElementById('modalPrice').textContent=p.price.toLocaleString()+'ƒë';
    document.getElementById('modalQty').textContent=1;document.getElementById('customNote').value='';
    document.getElementById('noteChips').innerHTML=NOTES.map(n=>'<div class="chip chip-note" onclick="toggleNote(this,\''+n+'\')">'+n+'</div>').join('');
    let tops=[],label=document.getElementById('toppingLabel');
    if(p.cat==='traicay'){tops=TOPPINGS_FRUIT;label.style.display='flex';}
    else if(p.cat==='topping'){label.style.display='none';tops=[];}
    else{tops=TOPPINGS_BASIC;label.style.display='flex';}
    excludeMode=false;document.getElementById('excludeToggle').classList.remove('active');
    document.getElementById('toppingChips').innerHTML=tops.map(t=>'<div class="chip" onclick="toggleTopping(this,\''+t+'\')">'+t+'</div>').join('');
    updateModalTotal();document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(e){if(!e||e.target.id==='modalOverlay')document.getElementById('modalOverlay').classList.remove('show');}
function adjustQty(d){if(currentItem.qty+d>0){currentItem.qty+=d;document.getElementById('modalQty').textContent=currentItem.qty;updateModalTotal();}}
function toggleNote(el,n){el.classList.toggle('active');currentItem.notes=el.classList.contains('active')?[...currentItem.notes,n]:currentItem.notes.filter(x=>x!==n);}
function toggleExcludeMode(){excludeMode=!excludeMode;document.getElementById('excludeToggle').classList.toggle('active',excludeMode);document.querySelectorAll('#toppingChips .chip').forEach(c=>{c.classList.toggle('exclude',excludeMode);c.classList.remove('active');});currentItem.tops=[];}
function toggleTopping(el,t){el.classList.toggle('active');const name=excludeMode?'Kh√¥ng '+t:t;if(el.classList.contains('active'))currentItem.tops.push({name,price:0});else currentItem.tops=currentItem.tops.filter(x=>x.name!==name);}
function updateModalTotal(){document.getElementById('modalTotal').textContent=(currentItem.price*currentItem.qty).toLocaleString()+'ƒë';}
function addToCart(){currentItem.customNote=document.getElementById('customNote').value.trim();cart.push({...currentItem,cartId:Date.now()});document.getElementById('modalOverlay').classList.remove('show');updateCartBar();}

function updateCartBar(){const bar=document.getElementById('cartBar');if(cart.length>0){bar.classList.add('show');document.getElementById('cartBadge').textContent=cart.reduce((s,i)=>s+i.qty,0);document.getElementById('cartTotal').textContent=cart.reduce((s,i)=>s+(i.price*i.qty),0).toLocaleString()+'ƒë';}else{bar.classList.remove('show');}}
function openCartModal(){renderCartItems();document.getElementById('cartModalOverlay').classList.add('show');}
function closeCartModal(e){if(!e||e.target.id==='cartModalOverlay')document.getElementById('cartModalOverlay').classList.remove('show');}
function renderCartItems(){
    const body=document.getElementById('cartBody');
    if(!cart.length){body.innerHTML='<div class="cart-empty">üõí Gi·ªè h√†ng tr·ªëng</div>';document.getElementById('cartSummaryTotal').textContent='0ƒë';return;}
    body.innerHTML=cart.map((item,i)=>{
        let d=[];if(item.notes.length)d.push(item.notes.join(', '));if(item.tops.length)d.push(item.tops.map(t=>t.name).join(', '));if(item.customNote)d.push('üìù '+item.customNote);
        return '<div class="cart-item"><img class="cart-item-img" src="'+item.img+'" onerror="this.style.background=\'#eee\'"><div class="cart-item-info"><div class="cart-item-name">'+item.name+'</div>'+(d.length?'<div class="cart-item-detail">'+d.join(' ‚Ä¢ ')+'</div>':'')+'<div class="cart-item-bottom"><div class="cart-item-price">'+(item.price*item.qty).toLocaleString()+'ƒë</div><div class="cart-item-qty"><button class="cart-qty-btn '+(item.qty===1?'delete':'')+'" onclick="updateCartItem('+i+',-1)">'+(item.qty===1?'üóëÔ∏è':'‚àí')+'</button><span class="cart-item-num">'+item.qty+'</span><button class="cart-qty-btn" onclick="updateCartItem('+i+',1)">+</button></div></div></div></div>';
    }).join('');
    document.getElementById('cartSummaryTotal').textContent=cart.reduce((s,i)=>s+(i.price*i.qty),0).toLocaleString()+'ƒë';
}
function updateCartItem(i,d){if(cart[i].qty+d<=0)cart.splice(i,1);else cart[i].qty+=d;renderCartItems();updateCartBar();}
function clearCart(){if(cart.length&&confirm('X√≥a t·∫•t c·∫£?')){cart=[];renderCartItems();updateCartBar();}}

async function submitOrder(){
    if(!cart.length)return alert('‚ö†Ô∏è Gi·ªè h√†ng tr·ªëng!');
    const pin=localStorage.getItem('khi_pin');if(!pin||!staffInfo){alert('‚ö†Ô∏è Phi√™n h·∫øt h·∫°n!');logout();return;}
    const data={order_id:document.getElementById('orderId').textContent,customer:document.getElementById('customerName').value||'Kh√°ch l·∫ª',staff_name:staffInfo.name,staff_pin:pin,items:cart.map(i=>({name:i.name,price:i.price,qty:i.qty,tops:i.tops,notes:i.customNote?[...i.notes,i.customNote]:i.notes})),total:cart.reduce((s,i)=>s+(i.price*i.qty),0)};
    const btn=document.getElementById('submitBtn');btn.innerHTML='<span class="loading"></span>ƒêang g·ª≠i...';btn.disabled=true;
    try{
        const res=await fetch('/api/submit_order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const result=await res.json();
        if(result.success){alert('‚úÖ ƒê√£ g·ª≠i order!');cart=[];updateCartBar();document.getElementById('cartModalOverlay').classList.remove('show');document.getElementById('customerName').value='';document.getElementById('orderId').textContent=Math.floor(Math.random()*900)+100;}
        else{alert('‚ùå '+result.message);}
    }catch(err){alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi!');}
    btn.innerHTML='G·ª¨I B·∫æP üöÄ';btn.disabled=false;
}
checkAuth();
</script>
</body>
</html>
