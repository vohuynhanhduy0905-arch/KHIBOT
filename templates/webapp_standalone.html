<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order - KH·ªà MILKTEA</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{--primary:#1A5336;--primary-light:#2d7a4a;--accent:#C9A86C;--bg:#FDF8F3;--text:#333;--text-light:#666;--border:#e8e0d8;--success:#27ae60;--shadow:0 4px 15px rgba(0,0,0,.1)}
        body{background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:var(--text);min-height:100vh;padding-bottom:90px}
        .login-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;z-index:1000}
        .login-box{background:#fff;padding:40px 30px;border-radius:24px;text-align:center;width:90%;max-width:320px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
        .login-logo{width:80px;height:80px;margin-bottom:20px;border-radius:50%}
        .login-title{font-size:20px;font-weight:700;margin-bottom:8px;color:var(--primary)}
        .login-subtitle{font-size:13px;color:var(--text-light);margin-bottom:25px}
        .login-input{width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;font-size:20px;text-align:center;letter-spacing:8px;font-weight:700;outline:none;margin-bottom:15px}
        .login-input:focus{border-color:var(--primary)}
        .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer}
        .login-error{color:#e74c3c;font-size:12px;margin-top:10px}
        .header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);color:#fff;padding:12px 15px;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.15)}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .order-num{font-size:11px;opacity:.8;background:rgba(255,255,255,.2);padding:4px 8px;border-radius:12px}
        .staff-info{display:flex;align-items:center;gap:8px}
        .staff-name{font-size:12px;font-weight:600}
        .logout-btn{background:rgba(255,255,255,.2);border:none;color:#fff;padding:4px 10px;border-radius:8px;font-size:11px;cursor:pointer}
        .brand{font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
        .brand img{width:32px;height:32px;border-radius:8px;border:2px solid rgba(255,255,255,.3)}
        .customer-input{width:100%;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.1);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;outline:none;transition:all .2s}
        .customer-input:focus{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.3)}
        .customer-input::placeholder{color:rgba(255,255,255,.7)}
        .search-wrap{padding:12px 15px;background:#fff;border-bottom:1px solid var(--border)}
        .search-box{display:flex;align-items:center;background:#f5f5f5;border-radius:25px;padding:8px 15px;gap:10px}
        .search-box svg{width:18px;height:18px;color:var(--text-light);flex-shrink:0}
        .search-input{flex:1;border:none;background:transparent;font-size:14px;outline:none}
        .search-input::placeholder{color:#999}
        .search-clear{width:20px;height:20px;border:none;background:#ddd;border-radius:50%;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center}
        .search-clear.show{display:flex}
        .categories{display:flex;overflow-x:auto;padding:12px 15px;gap:10px;background:#fff;border-bottom:1px solid var(--border)}
        .categories::-webkit-scrollbar{display:none}
        .cat-btn{flex-shrink:0;padding:10px 18px;border-radius:25px;border:2px solid var(--border);background:#fff;color:var(--text-light);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
        .cat-btn:active{transform:scale(.95)}
        .cat-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(26,83,54,.3)}
        .products{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:15px}
        .product-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);cursor:pointer;border:1px solid var(--border);transition:all .2s;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .product-card:active{transform:scale(.96)}
        .prod-img{width:100%;aspect-ratio:1;object-fit:cover;background:#f5f5f5;background-image:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .prod-img[src*="logo"]{object-fit:contain;padding:15px;background:#f9f9f9}
        .prod-img.loaded{animation:none;background:#f9f9f9}
        .prod-info{padding:10px 8px;text-align:center}
        .prod-name{font-size:11px;font-weight:600;line-height:1.3;height:30px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;color:var(--text)}
        .prod-price{font-size:13px;font-weight:700;color:var(--primary);margin-top:4px}
        .no-results{grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:12px 15px;display:none;align-items:center;box-shadow:0 -4px 20px rgba(0,0,0,.15);z-index:100;gap:12px;animation:slideUpBar .3s ease}
        @keyframes slideUpBar{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .cart-bar.show{display:flex}
        .cart-preview{flex:1;display:flex;align-items:center;gap:12px;cursor:pointer;padding:10px 12px;background:linear-gradient(135deg,#f9f9f9,#f0f0f0);border-radius:12px}
        .cart-badge{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(26,83,54,.3)}
        .cart-text{flex:1}
        .cart-label{font-size:11px;color:var(--text-light)}
        .cart-total{font-size:17px;font-weight:700;color:var(--primary)}
        .cart-btn{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(26,83,54,.3)}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:#fff;padding:12px 20px;border-radius:25px;font-size:13px;font-weight:600;z-index:300;opacity:0;transition:all .3s ease;display:flex;align-items:center;gap:8px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;backdrop-filter:blur(2px)}
        .modal-overlay.show{display:flex}
        .modal{background:#fff;width:100%;max-height:90vh;border-radius:24px 24px 0 0;display:flex;flex-direction:column;animation:slideUp .3s ease}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-close{width:36px;height:36px;border:none;background:#f0f0f0;border-radius:50%;font-size:20px;cursor:pointer}
        .modal-product{display:flex;align-items:center;gap:12px;flex:1}
        .modal-img{width:55px;height:55px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
        .modal-name{font-size:16px;font-weight:700}
        .modal-price{font-size:14px;color:var(--primary);font-weight:600}
        .modal-body{padding:15px;overflow-y:auto;flex:1}
        .qty-section{display:flex;justify-content:space-between;align-items:center;padding:14px;background:linear-gradient(135deg,#f9f9f9,#f5f5f5);border-radius:14px;margin-bottom:15px}
        .qty-label{font-weight:600;font-size:15px}
        .qty-control{display:flex;align-items:center;gap:15px}
        .qty-btn{width:40px;height:40px;border:none;background:#fff;border-radius:12px;font-size:22px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .qty-num{font-size:20px;font-weight:700;min-width:35px;text-align:center}
        .section-label{font-size:12px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin:15px 0 10px}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .chip{padding:10px 14px;border:2px solid var(--border);border-radius:25px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;transition:all .15s}
        .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .custom-note{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:12px;font-size:14px;margin-top:10px;outline:none;resize:none;font-family:inherit}
        .custom-note:focus{border-color:var(--primary)}
        .modal-footer{padding:15px;border-top:1px solid var(--border)}
        .add-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer}
        .cart-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .cart-title{font-size:18px;font-weight:700}
        .cart-clear{color:#e74c3c;font-size:13px;cursor:pointer;font-weight:600}
        .cart-body{flex:1;overflow-y:auto;padding:10px 15px}
        .cart-empty{text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-item{display:flex;gap:12px;padding:14px;background:#f9f9f9;border-radius:14px;margin-bottom:10px}
        .cart-item-img{width:55px;height:55px;border-radius:10px;object-fit:cover}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:14px;margin-bottom:3px}
        .cart-item-detail{font-size:11px;color:var(--text-light);line-height:1.4}
        .cart-item-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
        .cart-item-price{font-weight:700;color:var(--primary);font-size:15px}
        .cart-item-qty{display:flex;align-items:center;gap:8px;background:#fff;padding:4px;border-radius:10px}
        .cart-qty-btn{width:28px;height:28px;border:none;background:#f0f0f0;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer}
        .cart-qty-btn.delete{background:#ffe5e5;color:#e74c3c}
        .cart-item-num{font-weight:600;min-width:24px;text-align:center;font-size:14px}
        .cart-footer{padding:15px;border-top:1px solid var(--border)}
        .cart-summary{display:flex;justify-content:space-between;margin-bottom:12px;font-size:14px}
        .cart-summary-total{font-weight:700;font-size:18px;color:var(--primary)}
        .checkout-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer}
        .checkout-btn:disabled{opacity:.6}
        .loading{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite;margin-right:8px}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <img src="/static/logo.png" class="login-logo" alt="Logo">
            <div class="login-title">KH·ªà MILKTEA</div>
            <div class="login-subtitle">Nh·∫≠p m√£ PIN ƒë·ªÉ ƒëƒÉng nh·∫≠p</div>
            <input type="tel" class="login-input" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            <button class="login-btn" onclick="login()">ƒêƒÉng nh·∫≠p</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>
    <div id="mainApp" style="display:none">
        <div class="header">
            <div class="header-top">
                <div class="staff-info"><span class="staff-name" id="staffName">NV</span><button class="logout-btn" onclick="logout()">ƒê·ªïi</button></div>
                <div class="brand"><img src="/static/logo.png" alt="">KH·ªà MILKTEA</div>
            </div>
            <input class="customer-input" id="customerName" placeholder="üë§ T√™n kh√°ch h√†ng..." autocomplete="off">
        </div>
        <div class="search-wrap">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input class="search-input" id="searchInput" placeholder="T√¨m m√≥n..." autocomplete="off">
                <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
            </div>
        </div>
        <div class="categories" id="categories"></div>
        <div class="products" id="products"></div>
        <div class="cart-bar" id="cartBar">
            <div class="cart-preview" onclick="openCartModal()">
                <div class="cart-badge" id="cartCount">0</div>
                <div class="cart-text"><div class="cart-label">Gi·ªè h√†ng</div><div class="cart-total" id="cartTotal">0ƒë</div></div>
            </div>
            <button class="cart-btn" onclick="openCartModal()">Xem gi·ªè ‚Üí</button>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toastText"></span></div>
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-product"><img class="modal-img" id="modalImg" src="/static/logo.png"><div><div class="modal-name" id="modalName"></div><div class="modal-price" id="modalPrice"></div></div></div>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="qty-section"><span class="qty-label">S·ªë l∆∞·ª£ng</span><div class="qty-control"><button class="qty-btn" onclick="adjustQty(-1)">‚àí</button><span class="qty-num" id="modalQty">1</span><button class="qty-btn" onclick="adjustQty(1)">+</button></div></div>
                <div class="section-label" id="toppingLabel">Topping</div>
                <div class="chips" id="toppingChips"></div>
                <div class="section-label">Ghi ch√∫</div>
                <div class="chips" id="noteChips"></div>
                <textarea class="custom-note" id="customNote" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
            </div>
            <div class="modal-footer"><button class="add-btn" onclick="addToCart()">Th√™m v√†o gi·ªè ¬∑ <span id="modalTotal">0ƒë</span></button></div>
        </div>
    </div>
    <div class="modal-overlay" id="cartOverlay" onclick="closeCartModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="cart-header"><span class="cart-title">üõí Gi·ªè h√†ng</span><span class="cart-clear" onclick="clearCart()">X√≥a t·∫•t c·∫£</span></div>
            <div class="cart-body" id="cartBody"><div class="cart-empty">üõí Gi·ªè h√†ng tr·ªëng</div><div id="cartItems"></div></div>
            <div class="cart-footer"><div class="cart-summary"><span>T·ªïng c·ªông:</span><span class="cart-summary-total" id="cartSummaryTotal">0ƒë</span></div><button class="checkout-btn" id="checkoutBtn" onclick="submitOrder()">G·ª¨I B·∫æP üöÄ</button></div>
        </div>
    </div>
<script>
const CATEGORIES=[{id:'trasua',name:'üßã Tr√† S·ªØa'},{id:'traicay',name:'üçπ Tr√† Tr√°i C√¢y'},{id:'macchiato',name:'‚òÅÔ∏è Macchiato'},{id:'topping',name:'üßÅ Topping'}];
const TOPPINGS_BASIC=[{n:'Tr√¢n ch√¢u ƒëen',p:5000},{n:'Tr√¢n ch√¢u tr·∫Øng',p:5000},{n:'Th·∫°ch d·ª´a',p:5000},{n:'Pudding',p:7000},{n:'Kem cheese',p:10000}];
const TOPPINGS_FRUIT=[{n:'Th·∫°ch d·ª´a',p:5000},{n:'H·∫°t √©',p:5000},{n:'Nha ƒëam',p:5000},{n:'Tr√°i c√¢y t∆∞∆°i',p:10000}];
const NOTES=['√çt ƒë∆∞·ªùng','Nhi·ªÅu ƒë√°','√çt ƒë√°','Kh√¥ng ƒë√°','N√≥ng'];
const PRODUCTS=[
    {id:1,cat:'trasua',name:'Tr√† S·ªØa Truy·ªÅn Th·ªëng',price:25000,img:'/static/menu/ts-truyenthong.jpg'},
    {id:2,cat:'trasua',name:'Tr√† S·ªØa Matcha',price:25000,img:'/static/menu/ts-matcha.jpg'},
    {id:3,cat:'trasua',name:'Tr√† S·ªØa Caramel',price:25000,img:'/static/menu/ts-caramel.jpg'},
    {id:4,cat:'trasua',name:'Tr√† S·ªØa √î Long',price:25000,img:'/static/menu/ts-olong.jpg'},
    {id:5,cat:'trasua',name:'Tr√† S·ªØa Chocolate',price:25000,img:'/static/menu/ts-chocolate.jpg'},
    {id:6,cat:'trasua',name:'Tr√† S·ªØa ƒê√†o',price:25000,img:'/static/menu/ts-dao.jpg'},
    {id:10,cat:'traicay',name:'Tr√† ƒê√°c D√¢u T·∫±m',price:27000,img:'/static/menu/tc-dacdautam.jpg'},
    {id:11,cat:'traicay',name:'Tr√† ƒê√°c Th∆°m',price:27000,img:'/static/menu/tc-dacthom.jpg'},
    {id:12,cat:'traicay',name:'Tr√† ·ªîi H·ªìng',price:27000,img:'/static/menu/tc-oihong.jpg'},
    {id:13,cat:'traicay',name:'Tr√† Nhi·ªát ƒê·ªõi',price:27000,img:'/static/menu/tc-nhietdoi.jpg'},
    {id:14,cat:'traicay',name:'Tr√† T√°o Xanh',price:27000,img:'/static/menu/tc-taoxanh.jpg'},
    {id:15,cat:'traicay',name:'Tr√† D∆∞a L∆∞·ªõi',price:27000,img:'/static/menu/tc-dualuoi.jpg'},
    {id:16,cat:'traicay',name:'Tr√† M√£ng C·∫ßu',price:27000,img:'/static/menu/tc-mangcau.jpg'},
    {id:17,cat:'traicay',name:'Tr√† C√≥c H·∫°t ƒê√°c',price:27000,img:'/static/menu/tc-cochatdac.jpg'},
    {id:20,cat:'macchiato',name:'Tr√† ƒê√†o Macchiato',price:25000,img:'/static/menu/mc-dao.jpg'},
    {id:21,cat:'macchiato',name:'Tr√† D√¢u Macchiato',price:25000,img:'/static/menu/mc-dau.jpg'},
    {id:22,cat:'macchiato',name:'Tr√† V·∫£i Macchiato',price:25000,img:'/static/menu/mc-vai.jpg'},
    {id:23,cat:'macchiato',name:'H·ªìng Tr√† Macchiato',price:25000,img:'/static/menu/mc-hongtra.jpg'},
    {id:24,cat:'macchiato',name:'√î Long Macchiato',price:25000,img:'/static/menu/mc-olong.jpg'},
    {id:30,cat:'topping',name:'Tr√¢n Ch√¢u ƒêen',price:5000,img:'/static/menu/tp-tranchau.jpg'},
    {id:31,cat:'topping',name:'Pudding Tr·ª©ng',price:7000,img:'/static/menu/tp-pudding.jpg'},
    {id:32,cat:'topping',name:'Th·∫°ch D·ª´a',price:5000,img:'/static/menu/tp-thachdua.jpg'},
];
let currentCat='trasua',currentItem=null,cart=[],searchQuery='',staffInfo=null;
const orderId='KHI'+Date.now().toString().slice(-6);

async function login(){
    const pin=document.getElementById('pinInput').value;
    if(pin.length!==4){document.getElementById('loginError').textContent='Vui l√≤ng nh·∫≠p 4 s·ªë';return;}
    try{
        const res=await fetch('/api/verify_pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin})});
        const data=await res.json();
        if(data.success){staffInfo=data.staff;localStorage.setItem('khi_pin',pin);showApp();}
        else{document.getElementById('loginError').textContent=data.message;}
    }catch(e){document.getElementById('loginError').textContent='L·ªói k·∫øt n·ªëi!';}
}
function logout(){localStorage.removeItem('khi_pin');staffInfo=null;document.getElementById('loginScreen').style.display='flex';document.getElementById('mainApp').style.display='none';document.getElementById('pinInput').value='';}
function showApp(){document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='block';document.getElementById('staffName').textContent=staffInfo.name;initApp();}
async function checkAuth(){
    const pin=localStorage.getItem('khi_pin');
    if(pin){
        try{const res=await fetch('/api/verify_pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin})});const data=await res.json();if(data.success){staffInfo=data.staff;showApp();return;}}catch(e){}
    }
    document.getElementById('loginScreen').style.display='flex';
}
function initApp(){
    document.getElementById('categories').innerHTML=CATEGORIES.map((c,i)=>`<button class="cat-btn${i===0?' active':''}" onclick="selectCat('${c.id}',this)">${c.name}</button>`).join('');
    renderProducts();
}
const searchInput=document.getElementById('searchInput'),searchClear=document.getElementById('searchClear');
searchInput.addEventListener('input',e=>{searchQuery=e.target.value.toLowerCase().trim();searchClear.classList.toggle('show',searchQuery.length>0);renderProducts();});
function clearSearch(){searchInput.value='';searchQuery='';searchClear.classList.remove('show');renderProducts();}
function selectCat(id,btn){currentCat=id;document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');clearSearch();renderProducts();}
function renderProducts(){
    let filtered=PRODUCTS.filter(p=>p.cat===currentCat);
    if(searchQuery)filtered=PRODUCTS.filter(p=>p.name.toLowerCase().includes(searchQuery));
    if(!filtered.length){document.getElementById('products').innerHTML='<div class="no-results">Kh√¥ng t√¨m th·∫•y</div>';return;}
    document.getElementById('products').innerHTML=filtered.map(p=>`<div class="product-card" onclick="openModal(${p.id})"><img class="prod-img" src="/static/logo.png" data-src="${p.img}" loading="lazy"><div class="prod-info"><div class="prod-name">${p.name}</div><div class="prod-price">${p.price.toLocaleString()}ƒë</div></div></div>`).join('');
    requestAnimationFrame(()=>{document.querySelectorAll('.prod-img[data-src]').forEach(img=>{const src=img.dataset.src;const n=new Image();n.onload=()=>{img.src=src;img.classList.add('loaded');};n.onerror=()=>{img.src='/static/logo.png';img.classList.add('loaded');};n.src=src;});});
}
function openModal(id){
    const p=PRODUCTS.find(x=>x.id===id);currentItem={...p,qty:1,tops:[],notes:[],customNote:''};
    document.getElementById('modalImg').src=p.img;document.getElementById('modalImg').onerror=function(){this.src='/static/logo.png';};
    document.getElementById('modalName').textContent=p.name;document.getElementById('modalPrice').textContent=p.price.toLocaleString()+'ƒë';
    document.getElementById('modalQty').textContent=1;document.getElementById('customNote').value='';
    document.getElementById('noteChips').innerHTML=NOTES.map(n=>`<div class="chip" onclick="toggleNote(this,'${n}')">${n}</div>`).join('');
    let toppings=[],label=document.getElementById('toppingLabel');
    if(p.cat==='traicay'){toppings=TOPPINGS_FRUIT;label.style.display='block';}
    else if(p.cat==='topping'){label.style.display='none';}
    else{toppings=TOPPINGS_BASIC;label.style.display='block';}
    document.getElementById('toppingChips').innerHTML=toppings.map(t=>`<div class="chip" onclick="toggleTopping(this,'${t.n}',${t.p})">${t.n} +${t.p/1000}k</div>`).join('');
    updateModalTotal();document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(e){if(!e||e.target.id==='modalOverlay'||e.target.classList.contains('modal-close'))document.getElementById('modalOverlay').classList.remove('show');}
function adjustQty(d){if(currentItem.qty+d>0){currentItem.qty+=d;document.getElementById('modalQty').textContent=currentItem.qty;updateModalTotal();}}
function toggleNote(el,note){el.classList.toggle('active');currentItem.notes=el.classList.contains('active')?[...currentItem.notes,note]:currentItem.notes.filter(n=>n!==note);}
function toggleTopping(el,name,price){el.classList.toggle('active');if(el.classList.contains('active'))currentItem.tops.push({name,price});else currentItem.tops=currentItem.tops.filter(t=>t.name!==name);updateModalTotal();}
function updateModalTotal(){const topPrice=currentItem.tops.reduce((s,t)=>s+t.price,0);document.getElementById('modalTotal').textContent=((currentItem.price+topPrice)*currentItem.qty).toLocaleString()+'ƒë';}
function addToCart(){currentItem.customNote=document.getElementById('customNote').value;cart.push({...currentItem,cartId:Date.now()});updateCartBar();closeModal();showToast('ƒê√£ th√™m v√†o gi·ªè');}
function showToast(text){const toast=document.getElementById('toast');document.getElementById('toastText').textContent=text;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000);}
function updateCartBar(){const total=cart.reduce((s,i)=>{const tp=i.tops.reduce((ts,t)=>ts+t.price,0);return s+(i.price+tp)*i.qty;},0);const count=cart.reduce((s,i)=>s+i.qty,0);document.getElementById('cartCount').textContent=count;document.getElementById('cartTotal').textContent=total.toLocaleString()+'ƒë';document.getElementById('cartSummaryTotal').textContent=total.toLocaleString()+'ƒë';document.getElementById('cartBar').classList.toggle('show',cart.length>0);}
function openCartModal(){renderCartItems();document.getElementById('cartOverlay').classList.add('show');}
function closeCartModal(e){if(!e||e.target.id==='cartOverlay')document.getElementById('cartOverlay').classList.remove('show');}
function clearCart(){cart=[];updateCartBar();renderCartItems();showToast('ƒê√£ x√≥a gi·ªè');}
function renderCartItems(){
    const container=document.getElementById('cartItems'),body=document.getElementById('cartBody');
    if(!cart.length){body.querySelector('.cart-empty').style.display='block';container.innerHTML='';return;}
    body.querySelector('.cart-empty').style.display='none';
    container.innerHTML=cart.map((item,idx)=>{const tp=item.tops.reduce((s,t)=>s+t.price,0);const total=(item.price+tp)*item.qty;const details=[...item.tops.map(t=>t.name),...item.notes,item.customNote].filter(Boolean).join(', ');return`<div class="cart-item"><img class="cart-item-img" src="${item.img}" onerror="this.src='/static/logo.png'"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div>${details?`<div class="cart-item-detail">${details}</div>`:''}<div class="cart-item-bottom"><span class="cart-item-price">${total.toLocaleString()}ƒë</span><div class="cart-item-qty"><button class="cart-qty-btn ${item.qty===1?'delete':''}" onclick="changeCartQty(${idx},-1)">${item.qty===1?'üóë':'‚àí'}</button><span class="cart-item-num">${item.qty}</span><button class="cart-qty-btn" onclick="changeCartQty(${idx},1)">+</button></div></div></div></div>`;}).join('');
}
function changeCartQty(idx,d){if(cart[idx].qty+d<=0)cart.splice(idx,1);else cart[idx].qty+=d;updateCartBar();renderCartItems();}
async function submitOrder(){
    if(!cart.length){showToast('Gi·ªè h√†ng tr·ªëng!');return;}
    const pin=localStorage.getItem('khi_pin');if(!pin||!staffInfo){showToast('Phi√™n h·∫øt h·∫°n!');logout();return;}
    const total=cart.reduce((s,i)=>{const tp=i.tops.reduce((ts,t)=>ts+t.price,0);return s+(i.price+tp)*i.qty;},0);
    const data={order_id:orderId,customer:document.getElementById('customerName').value||'Kh√°ch l·∫ª',staff_name:staffInfo.name,staff_pin:pin,items:cart.map(i=>({name:i.name,price:i.price,qty:i.qty,tops:i.tops,notes:[...i.notes,i.customNote].filter(Boolean)})),total};
    const btn=document.getElementById('checkoutBtn');btn.innerHTML='<span class="loading"></span>ƒêang g·ª≠i...';btn.disabled=true;
    try{
        const res=await fetch('/api/submit_order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const result=await res.json();
        if(result.success){showToast('‚úÖ ƒê√£ g·ª≠i order!');cart=[];updateCartBar();closeCartModal();document.getElementById('customerName').value='';}
        else showToast('‚ùå '+result.message);
    }catch(e){showToast('‚ùå L·ªói k·∫øt n·ªëi!');}
    btn.innerHTML='G·ª¨I B·∫æP üöÄ';btn.disabled=false;
}
checkAuth();
</script>
</body>
</html>
