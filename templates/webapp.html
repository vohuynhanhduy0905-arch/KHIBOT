<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order - KH·ªà MILKTEA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{--primary:#1A5336;--primary-light:#2d7a4a;--accent:#C9A86C;--bg:#FDF8F3;--text:#333;--text-light:#666;--border:#e8e0d8;--danger:#e74c3c}
        body{background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:var(--text);min-height:100vh;padding-bottom:90px}
        .header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);color:#fff;padding:12px 15px;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.15)}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .order-num{font-size:11px;opacity:.8;background:rgba(255,255,255,.2);padding:4px 8px;border-radius:12px}
        .brand{font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
        .brand img{width:32px;height:32px;border-radius:8px;border:2px solid rgba(255,255,255,.3)}
        .customer-input{width:100%;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.1);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;outline:none;transition:all .2s}
        .customer-input:focus{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.3)}
        .customer-input::placeholder{color:rgba(255,255,255,.7)}
        .search-wrap{padding:12px 15px;background:#fff;border-bottom:1px solid var(--border)}
        .search-box{display:flex;align-items:center;background:#f5f5f5;border-radius:25px;padding:8px 15px;gap:10px}
        .search-box svg{width:18px;height:18px;color:var(--text-light);flex-shrink:0}
        .search-input{flex:1;border:none;background:transparent;font-size:14px;outline:none}
        .search-input::placeholder{color:#999}
        .search-clear{width:20px;height:20px;border:none;background:#ddd;border-radius:50%;font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center}
        .search-clear.show{display:flex}
        .categories{display:flex;overflow-x:auto;padding:12px 15px;gap:10px;background:#fff;border-bottom:1px solid var(--border)}
        .categories::-webkit-scrollbar{display:none}
        .cat-btn{flex-shrink:0;padding:10px 18px;border-radius:25px;border:2px solid var(--border);background:#fff;color:var(--text-light);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
        .cat-btn:active{transform:scale(.95)}
        .cat-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(26,83,54,.3)}
        .products{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:15px}
        .product-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1);cursor:pointer;border:1px solid var(--border);transition:all .2s;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .product-card:active{transform:scale(.96)}
        .prod-img{width:100%;aspect-ratio:1;object-fit:cover;background:#f5f5f5;background-image:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .prod-img[src*="logo"]{object-fit:contain;padding:15px;background:#f9f9f9}
        .prod-img.loaded{animation:none;background:#f9f9f9}
        .prod-info{padding:10px 8px;text-align:center}
        .prod-name{font-size:11px;font-weight:600;line-height:1.3;height:30px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;color:var(--text)}
        .prod-price{font-size:13px;font-weight:700;color:var(--primary);margin-top:4px}
        .no-results{grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:12px 15px;display:none;align-items:center;box-shadow:0 -4px 20px rgba(0,0,0,.15);z-index:100;gap:12px;animation:slideUpBar .3s ease}
        @keyframes slideUpBar{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .cart-bar.show{display:flex}
        .cart-preview{flex:1;display:flex;align-items:center;gap:12px;cursor:pointer;padding:10px 12px;background:linear-gradient(135deg,#f9f9f9,#f0f0f0);border-radius:12px}
        .cart-badge{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(26,83,54,.3)}
        .cart-text{flex:1}
        .cart-label{font-size:11px;color:var(--text-light)}
        .cart-total{font-size:17px;font-weight:700;color:var(--primary)}
        .cart-btn{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(26,83,54,.3)}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:#fff;padding:12px 20px;border-radius:25px;font-size:13px;font-weight:600;z-index:300;opacity:0;transition:all .3s ease;box-shadow:0 4px 20px rgba(0,0,0,.3)}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;backdrop-filter:blur(2px)}
        .modal-overlay.show{display:flex}
        .modal{background:#fff;width:100%;max-height:90vh;border-radius:24px 24px 0 0;display:flex;flex-direction:column;animation:slideUp .3s ease}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-close{width:36px;height:36px;border:none;background:#f0f0f0;border-radius:50%;font-size:20px;cursor:pointer}
        .modal-product{display:flex;align-items:center;gap:12px;flex:1}
        .modal-img{width:55px;height:55px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
        .modal-name{font-size:16px;font-weight:700}
        .modal-price{font-size:14px;color:var(--primary);font-weight:600}
        .modal-body{padding:15px;overflow-y:auto;flex:1}
        .qty-section{display:flex;justify-content:space-between;align-items:center;padding:14px;background:linear-gradient(135deg,#f9f9f9,#f5f5f5);border-radius:14px;margin-bottom:15px}
        .qty-label{font-weight:600;font-size:15px}
        .qty-control{display:flex;align-items:center;gap:15px}
        .qty-btn{width:40px;height:40px;border:none;background:#fff;border-radius:12px;font-size:22px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .qty-num{font-size:20px;font-weight:700;min-width:35px;text-align:center}
        .section-label{font-size:12px;font-weight:700;color:var(--text-light);text-transform:uppercase;margin:15px 0 10px}
        .section-hint{font-weight:400;font-size:11px;color:#999}
        .topping-header{display:flex;justify-content:space-between;align-items:center;margin:15px 0 10px}
        .toggle-wrap{display:flex;align-items:center;gap:8px}
        .toggle-label{font-size:11px;color:var(--text-light)}
        .toggle{position:relative;width:44px;height:24px;background:#ddd;border-radius:12px;cursor:pointer;transition:background .2s}
        .toggle.active{background:var(--danger)}
        .toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
        .toggle.active::after{transform:translateX(20px)}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .chip{padding:10px 14px;border:2px solid var(--border);border-radius:25px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;transition:all .15s}
        .chip:active{transform:scale(.95)}
        .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
        .chip.exclude{border-color:var(--danger);color:var(--danger)}
        .chip.exclude.active{background:var(--danger);color:#fff;border-color:var(--danger)}
        .chip-note.active{background:#555;border-color:#555}
        .custom-note{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:12px;font-size:14px;margin-top:10px;outline:none;resize:none;font-family:inherit}
        .custom-note:focus{border-color:var(--primary)}
        .modal-footer{padding:15px;border-top:1px solid var(--border)}
        .add-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(26,83,54,.3)}
        .cart-header{padding:15px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .cart-title{font-size:18px;font-weight:700}
        .cart-clear{color:var(--danger);font-size:13px;cursor:pointer;font-weight:600}
        .cart-body{flex:1;overflow-y:auto;padding:10px 15px}
        .cart-empty{text-align:center;padding:40px 20px;color:var(--text-light)}
        .cart-item{display:flex;gap:12px;padding:14px;background:#f9f9f9;border-radius:14px;margin-bottom:10px;animation:fadeIn .2s ease}
        .cart-item-img{width:55px;height:55px;border-radius:10px;object-fit:cover}
        .cart-item-info{flex:1}
        .cart-item-name{font-weight:600;font-size:14px;margin-bottom:3px}
        .cart-item-detail{font-size:11px;color:var(--text-light);line-height:1.4}
        .cart-item-bottom{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
        .cart-item-price{font-weight:700;color:var(--primary);font-size:15px}
        .cart-item-qty{display:flex;align-items:center;gap:8px;background:#fff;padding:4px;border-radius:10px}
        .cart-qty-btn{width:28px;height:28px;border:none;background:#f0f0f0;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer}
        .cart-qty-btn.delete{background:#ffe5e5;color:var(--danger)}
        .cart-item-num{font-weight:600;min-width:24px;text-align:center;font-size:14px}
        .cart-footer{padding:15px;border-top:1px solid var(--border)}
        .cart-summary{display:flex;justify-content:space-between;margin-bottom:12px;font-size:14px}
        .cart-summary-total{font-weight:700;font-size:18px;color:var(--primary)}
        .checkout-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer}
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <span class="order-num" id="orderNum">ƒê∆°n #001</span>
            <div class="brand"><img src="/static/logo.png" alt="">KH·ªà MILKTEA</div>
        </div>
        <input class="customer-input" id="customerName" placeholder="üë§ T√™n kh√°ch h√†ng..." autocomplete="off">
    </div>
    <div class="search-wrap">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input class="search-input" id="searchInput" placeholder="T√¨m m√≥n..." autocomplete="off">
            <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
        </div>
    </div>
    <div class="categories" id="categories"></div>
    <div class="products" id="products"></div>
    <div class="cart-bar" id="cartBar">
        <div class="cart-preview" onclick="openCartModal()">
            <div class="cart-badge" id="cartCount">0</div>
            <div class="cart-text"><div class="cart-label">Gi·ªè h√†ng</div><div class="cart-total" id="cartTotal">0ƒë</div></div>
        </div>
        <button class="cart-btn" onclick="openCartModal()">Xem gi·ªè ‚Üí</button>
    </div>
    <div class="toast" id="toast"><span id="toastText">ƒê√£ th√™m v√†o gi·ªè</span></div>
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-product"><img class="modal-img" id="modalImg" src="/static/logo.png"><div><div class="modal-name" id="modalName"></div><div class="modal-price" id="modalPrice"></div></div></div>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="qty-section"><span class="qty-label">S·ªë l∆∞·ª£ng</span><div class="qty-control"><button class="qty-btn" onclick="adjustQty(-1)">‚àí</button><span class="qty-num" id="modalQty">1</span><button class="qty-btn" onclick="adjustQty(1)">+</button></div></div>
                <div class="section-label">üìù Ghi ch√∫ nhanh</div>
                <div class="chips" id="noteChips"></div>
                <textarea class="custom-note" id="customNote" rows="2" placeholder="Ghi ch√∫ th√™m (VD: √≠t ƒë∆∞·ªùng, th√™m kem...)"></textarea>
                <div class="topping-header" id="toppingLabel">
                    <div class="section-label" style="margin:0">üç° Topping <span class="section-hint">(Kh√¥ng ch·ªçn = Full)</span></div>
                    <div class="toggle-wrap"><span class="toggle-label">Lo·∫°i b·ªè</span><div class="toggle" id="excludeToggle" onclick="toggleExcludeMode()"></div></div>
                </div>
                <div class="chips" id="toppingChips"></div>
            </div>
            <div class="modal-footer"><button class="add-btn" onclick="addToCart()">TH√äM V√ÄO ƒê∆†N ¬∑ <span id="modalTotal">0ƒë</span></button></div>
        </div>
    </div>
    <div class="modal-overlay" id="cartOverlay" onclick="closeCartModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="cart-header"><span class="cart-title">üõí Gi·ªè h√†ng</span><span class="cart-clear" onclick="clearCart()">üóëÔ∏è X√≥a t·∫•t c·∫£</span></div>
            <div class="cart-body" id="cartBody"><div class="cart-empty" id="cartEmpty">üõí Gi·ªè h√†ng tr·ªëng</div><div id="cartItems"></div></div>
            <div class="cart-footer"><div class="cart-summary"><span>T·ªïng c·ªông:</span><span class="cart-summary-total" id="cartSummaryTotal">0ƒë</span></div><button class="checkout-btn" onclick="checkout()">‚úì G·ª≠i ƒë∆°n</button></div>
        </div>
    </div>
<script>
const NOTES = ["√çt ƒë√°", "Kh√¥ng ƒë√°", "√çt ng·ªçt", "Nhi·ªÅu ng·ªçt", "Mang v·ªÅ"];
const TOPPINGS_BASIC = ["Tr√¢n Ch√¢u", "C·ªß NƒÉng", "Ph√¥ Mai", "Rau C√¢u", "Kh√∫c B·∫°ch", "S∆∞∆°ng S√°o", "Th·∫°ch ƒê√†o", "Flan Tr·ª©ng", "Ng·ªçc Trai", "Khoai D·∫ªo"];
const TOPPINGS_FRUIT = ["ƒê√°c Th∆°m", "ƒê√°c D√¢u T·∫±m", "Tr√°i C√¢y Nhi·ªát ƒê·ªõi", "T√°o Xanh", "D∆∞a L∆∞·ªõi", "·ªîi H·ªìng", "M√£ng C·∫ßu"];
const CATEGORIES = [
    {id:'trasua',name:'üßã Tr√† S·ªØa'},
    {id:'traicay',name:'üçπ Tr√† Tr√°i C√¢y'},
    {id:'macchiato',name:'ü•õ Macchiato'},
    {id:'dacbiet',name:'‚≠ê ƒê·∫∑c Bi·ªát'},
    {id:'topping',name:'üç° Topping Th√™m'}
];
const PRODUCTS = [
    // TR√Ä S·ªÆA 25K
    {id:1,cat:'trasua',name:'Tr√† S·ªØa Truy·ªÅn Th·ªëng',price:25000,img:'/static/menu/ts-truyenthong.jpg'},
    {id:2,cat:'trasua',name:'Tr√† S·ªØa Matcha',price:25000,img:'/static/menu/ts-matcha.jpg'},
    {id:3,cat:'trasua',name:'Tr√† S·ªØa Caramel',price:25000,img:'/static/menu/ts-caramel.jpg'},
    {id:4,cat:'trasua',name:'Tr√† S·ªØa √î Long',price:25000,img:'/static/menu/ts-olong.jpg'},
    {id:5,cat:'trasua',name:'Tr√† S·ªØa Chocolate',price:25000,img:'/static/menu/ts-chocolate.jpg'},
    {id:6,cat:'trasua',name:'Tr√† S·ªØa ƒê√†o',price:25000,img:'/static/menu/ts-dao.jpg'},
    // TR√Ä TR√ÅI C√ÇY 27K
    {id:10,cat:'traicay',name:'Tr√† ƒê√°c D√¢u T·∫±m',price:27000,img:'/static/menu/tc-dacdautam.jpg'},
    {id:11,cat:'traicay',name:'Tr√† ƒê√°c Th∆°m',price:27000,img:'/static/menu/tc-dacthom.jpg'},
    {id:12,cat:'traicay',name:'Tr√† ·ªîi H·ªìng',price:27000,img:'/static/menu/tc-oihong.jpg'},
    {id:13,cat:'traicay',name:'Tr√† Nhi·ªát ƒê·ªõi',price:27000,img:'/static/menu/tc-nhietdoi.jpg'},
    {id:14,cat:'traicay',name:'Tr√† T√°o Xanh',price:27000,img:'/static/menu/tc-taoxanh.jpg'},
    {id:15,cat:'traicay',name:'Tr√† D∆∞a L∆∞·ªõi',price:27000,img:'/static/menu/tc-dualuoi.jpg'},
    {id:16,cat:'traicay',name:'Tr√† M√£ng C·∫ßu',price:27000,img:'/static/menu/tc-mangcau.jpg'},
    {id:17,cat:'traicay',name:'Tr√† C√≥c H·∫°t ƒê√°c',price:27000,img:'/static/menu/tc-cochatdac.jpg'},
    // MACCHIATO 25K
    {id:20,cat:'macchiato',name:'Tr√† ƒê√†o Macchiato',price:25000,img:'/static/menu/mc-dao.jpg'},
    {id:21,cat:'macchiato',name:'Tr√† D√¢u Macchiato',price:25000,img:'/static/menu/mc-dau.jpg'},
    {id:22,cat:'macchiato',name:'Tr√† V·∫£i Macchiato',price:25000,img:'/static/menu/mc-vai.jpg'},
    {id:23,cat:'macchiato',name:'H·ªìng Tr√† Macchiato',price:25000,img:'/static/menu/mc-hongtra.jpg'},
    {id:24,cat:'macchiato',name:'√î Long Macchiato',price:25000,img:'/static/menu/mc-olong.jpg'},
    {id:25,cat:'macchiato',name:'Tr√† Sen Macchiato',price:25000,img:'/static/menu/mc-sen.jpg'},
    // ƒê·∫∂C BI·ªÜT
    {id:30,cat:'dacbiet',name:'Tr√† S·ªßi',price:25000,img:'/static/menu/db-trasui.jpg'},
    {id:31,cat:'dacbiet',name:'S·ªØa T∆∞∆°i Tr√¢n Ch√¢u ƒê.ƒê',price:27000,img:'/static/menu/db-suatuoi.jpg'},
    {id:32,cat:'dacbiet',name:'H·ªìng Tr√† Latte',price:27000,img:'/static/menu/db-hongtralatte.jpg'},
    {id:33,cat:'dacbiet',name:'Matcha Latte',price:27000,img:'/static/menu/db-matchalatte.jpg'},
    // TOPPING TH√äM
    {id:100,cat:'topping',name:'Th√™m Tr√¢n Ch√¢u',price:5000,img:'/static/menu/tp-tranchau.jpg'},
    {id:101,cat:'topping',name:'Th√™m Ph√¥ Mai',price:5000,img:'/static/menu/tp-phomai.jpg'},
    {id:102,cat:'topping',name:'Th√™m Flan',price:5000,img:'/static/menu/tp-flan.jpg'},
    {id:103,cat:'topping',name:'Th√™m ƒê√°c Th∆°m',price:10000,img:'/static/menu/tp-dacthom.jpg'},
    {id:104,cat:'topping',name:'Th√™m ƒê√°c D√¢u T·∫±m',price:10000,img:'/static/menu/tp-dacdautam.jpg'},
    {id:105,cat:'topping',name:'Th√™m ·ªîi H·ªìng',price:10000,img:'/static/menu/tp-oihong.jpg'},
    {id:106,cat:'topping',name:'Th√™m M√£ng C·∫ßu',price:10000,img:'/static/menu/tp-mangcau.jpg'}
];
let currentCat='trasua',currentItem=null,cart=[],excludeMode=false,searchQuery='';
const orderId='KHI'+Date.now().toString().slice(-6);
document.getElementById('orderNum').textContent='ƒê∆°n #'+orderId.slice(-4);
document.getElementById('categories').innerHTML=CATEGORIES.map((c,i)=>`<button class="cat-btn${i===0?' active':''}" onclick="selectCat('${c.id}',this)">${c.name}</button>`).join('');
const searchInput=document.getElementById('searchInput'),searchClear=document.getElementById('searchClear');
searchInput.addEventListener('input',e=>{searchQuery=e.target.value.toLowerCase().trim();searchClear.classList.toggle('show',searchQuery.length>0);renderProducts();});
function clearSearch(){searchInput.value='';searchQuery='';searchClear.classList.remove('show');renderProducts();}
function selectCat(id,btn){currentCat=id;document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');clearSearch();renderProducts();}
function renderProducts(){
    let filtered=PRODUCTS.filter(p=>p.cat===currentCat);
    if(searchQuery)filtered=PRODUCTS.filter(p=>p.name.toLowerCase().includes(searchQuery));
    if(!filtered.length){document.getElementById('products').innerHTML='<div class="no-results">Kh√¥ng t√¨m th·∫•y "'+searchQuery+'"</div>';return;}
    document.getElementById('products').innerHTML=filtered.map(p=>`<div class="product-card" onclick="openModal(${p.id})"><img class="prod-img" src="/static/logo.png" data-src="${p.img}" loading="lazy"><div class="prod-info"><div class="prod-name">${p.name}</div><div class="prod-price">${p.price.toLocaleString()}ƒë</div></div></div>`).join('');
    requestAnimationFrame(()=>{document.querySelectorAll('.prod-img[data-src]').forEach(img=>{const src=img.dataset.src;const n=new Image();n.onload=()=>{img.src=src;img.classList.add('loaded');};n.onerror=()=>{img.src='/static/logo.png';img.classList.add('loaded');};n.src=src;});});
}
function openModal(id){
    const p=PRODUCTS.find(x=>x.id===id);currentItem={...p,qty:1,tops:[],notes:[],customNote:''};
    document.getElementById('modalImg').src=p.img;document.getElementById('modalImg').onerror=function(){this.src='/static/logo.png';};
    document.getElementById('modalName').textContent=p.name;document.getElementById('modalPrice').textContent=p.price.toLocaleString()+'ƒë';
    document.getElementById('modalQty').textContent=1;document.getElementById('customNote').value='';
    document.getElementById('noteChips').innerHTML=NOTES.map(n=>`<div class="chip chip-note" onclick="toggleNote(this,'${n}')">${n}</div>`).join('');
    let toppings=[],label=document.getElementById('toppingLabel');
    if(p.cat==='traicay'){toppings=TOPPINGS_FRUIT;label.style.display='flex';}
    else if(p.cat==='topping'){label.style.display='none';document.getElementById('toppingChips').innerHTML='';}
    else{toppings=TOPPINGS_BASIC;label.style.display='flex';}
    excludeMode=false;document.getElementById('excludeToggle').classList.remove('active');
    if(toppings.length)document.getElementById('toppingChips').innerHTML=toppings.map(t=>`<div class="chip" onclick="toggleTopping(this,'${t}')">${t}</div>`).join('');
    updateModalTotal();document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(e){if(!e||e.target.id==='modalOverlay'||e.target.classList.contains('modal-close'))document.getElementById('modalOverlay').classList.remove('show');}
function adjustQty(d){if(currentItem.qty+d>0){currentItem.qty+=d;document.getElementById('modalQty').textContent=currentItem.qty;updateModalTotal();}}
function toggleNote(el,note){el.classList.toggle('active');currentItem.notes=el.classList.contains('active')?[...currentItem.notes,note]:currentItem.notes.filter(n=>n!==note);}
function toggleExcludeMode(){excludeMode=!excludeMode;document.getElementById('excludeToggle').classList.toggle('active',excludeMode);document.querySelectorAll('#toppingChips .chip').forEach(chip=>{chip.classList.toggle('exclude',excludeMode);chip.classList.remove('active');});currentItem.tops=[];}
function toggleTopping(el,name){el.classList.toggle('active');if(el.classList.contains('active'))currentItem.tops.push((excludeMode?'Kh√¥ng ':'')+name);else currentItem.tops=currentItem.tops.filter(t=>t!==(excludeMode?'Kh√¥ng ':'')+name);}
function updateModalTotal(){document.getElementById('modalTotal').textContent=(currentItem.price*currentItem.qty).toLocaleString()+'ƒë';}
function addToCart(){currentItem.customNote=document.getElementById('customNote').value;cart.push({...currentItem,cartId:Date.now()});updateCartBar();closeModal();showToast('ƒê√£ th√™m v√†o gi·ªè');}
function showToast(text){const toast=document.getElementById('toast');document.getElementById('toastText').textContent=text;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000);}
function updateCartBar(){const total=cart.reduce((s,i)=>s+i.price*i.qty,0);const count=cart.reduce((s,i)=>s+i.qty,0);document.getElementById('cartCount').textContent=count;document.getElementById('cartTotal').textContent=total.toLocaleString()+'ƒë';document.getElementById('cartSummaryTotal').textContent=total.toLocaleString()+'ƒë';document.getElementById('cartBar').classList.toggle('show',cart.length>0);}
function openCartModal(){renderCartItems();document.getElementById('cartOverlay').classList.add('show');}
function closeCartModal(e){if(!e||e.target.id==='cartOverlay')document.getElementById('cartOverlay').classList.remove('show');}
function clearCart(){cart=[];updateCartBar();renderCartItems();showToast('ƒê√£ x√≥a gi·ªè h√†ng');}
function renderCartItems(){
    const container=document.getElementById('cartItems'),empty=document.getElementById('cartEmpty');
    if(!cart.length){empty.style.display='block';container.innerHTML='';return;}
    empty.style.display='none';
    container.innerHTML=cart.map((item,idx)=>{const details=[...item.tops,...item.notes,item.customNote].filter(Boolean).join(', ');return`<div class="cart-item"><img class="cart-item-img" src="${item.img}" onerror="this.src='/static/logo.png'"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div>${details?`<div class="cart-item-detail">${details}</div>`:''}<div class="cart-item-bottom"><span class="cart-item-price">${(item.price*item.qty).toLocaleString()}ƒë</span><div class="cart-item-qty"><button class="cart-qty-btn ${item.qty===1?'delete':''}" onclick="changeCartQty(${idx},-1)">${item.qty===1?'üóë':'‚àí'}</button><span class="cart-item-num">${item.qty}</span><button class="cart-qty-btn" onclick="changeCartQty(${idx},1)">+</button></div></div></div></div>`;}).join('');
}
function changeCartQty(idx,d){if(cart[idx].qty+d<=0)cart.splice(idx,1);else cart[idx].qty+=d;updateCartBar();renderCartItems();}
function checkout(){
    const customer=document.getElementById('customerName').value.trim()||'KH√ÅCH L·∫∫';
    if(!cart.length){showToast('Gi·ªè h√†ng tr·ªëng!');return;}
    const total=cart.reduce((s,i)=>s+i.price*i.qty,0);
    const orderData={order_id:orderId,customer:customer,items:cart.map(i=>({name:i.name,price:i.price,qty:i.qty,tops:i.tops,notes:[...i.notes,i.customNote].filter(Boolean)})),total:total};
    if(window.Telegram&&Telegram.WebApp)Telegram.WebApp.sendData(JSON.stringify(orderData));
    showToast('ƒê√£ g·ª≠i ƒë∆°n!');cart=[];updateCartBar();closeCartModal();
}
renderProducts();
</script>
</body>
</html>
