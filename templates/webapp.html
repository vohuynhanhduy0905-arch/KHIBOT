</div></div></div>`).join('');requestAnimationFrame(()=>{document.querySelectorAll('.prod-img[data-src]').forEach(img=>{const src=img.dataset.src;const n=new Image();n.onload=()=>{img.src=src;img.classList.add('loaded');img.removeAttribute('data-src');};n.onerror=()=>{img.src='/static/logo.png';img.classList.add('loaded');};n.src=src;});});}
function openModal(id){const p=PRODUCTS.find(x=>x.id===id);currentItem={...p,qty:1,tops:[],notes:[],customNote:''};document.getElementById('modalImg').src=p.img;document.getElementById('modalImg').onerror=function(){this.src='/static/logo.png';};document.getElementById('modalName').textContent=p.name;document.getElementById('modalPrice').textContent=p.price.toLocaleString()+'Ä‘';document.getElementById('modalQty').textContent=1;document.getElementById('customNote').value='';document.getElementById('noteChips').innerHTML=NOTES.map(n=>`<div class="chip chip-note" onclick="toggleNote(this,'${n}')">${n}</div>`).join('');let toppings=[],label=document.getElementById('toppingLabel');if(p.cat==='traicay'){toppings=TOPPINGS_FRUIT;label.style.display='flex';}else if(p.cat==='topping'){label.style.display='none';}else{toppings=TOPPINGS_BASIC;label.style.display='flex';}excludeMode=false;document.getElementById('excludeToggle').classList.remove('active');renderToppingChips(toppings);updateModalTotal();document.getElementById('modalOverlay').classList.add('show');}
function renderToppingChips(toppings){document.getElementById('toppingChips').innerHTML=toppings.map(t=>`<div class="chip${excludeMode?' exclude':''}" onclick="toggleTopping(this,'${t.n}',${t.p})">${t.n} +${t.p/1000}k</div>`).join('');}
function closeModal(e){if(!e||e.target.id==='modalOverlay'||e.target.classList.contains('modal-close'))document.getElementById('modalOverlay').classList.remove('show');}
function adjustQty(d){if(currentItem.qty+d>0){currentItem.qty+=d;document.getElementById('modalQty').textContent=currentItem.qty;updateModalTotal();}}
function toggleNote(el,note){el.classList.toggle('active');currentItem.notes=el.classList.contains('active')?[...currentItem.notes,note]:currentItem.notes.filter(n=>n!==note);}
function toggleExcludeMode(){excludeMode=!excludeMode;document.getElementById('excludeToggle').classList.toggle('active',excludeMode);document.querySelectorAll('#toppingChips .chip').forEach(chip=>{chip.classList.toggle('exclude',excludeMode);chip.classList.remove('active');});currentItem.tops=[];}
function toggleTopping(el,name,price){el.classList.toggle('active');if(el.classList.contains('active')){currentItem.tops.push({name:(excludeMode?'KhÃ´ng ':'')+name,price:excludeMode?0:price});}else{const prefix=excludeMode?'KhÃ´ng ':'';currentItem.tops=currentItem.tops.filter(t=>t.name!==prefix+name);}updateModalTotal();}
function updateModalTotal(){const topPrice=currentItem.tops.reduce((s,t)=>s+t.price,0);const total=(currentItem.price+topPrice)*currentItem.qty;document.getElementById('modalTotal').textContent=total.toLocaleString()+'Ä‘';}
function addToCart(){currentItem.customNote=document.getElementById('customNote').value;cart.push({...currentItem,cartId:Date.now()});updateCartBar();closeModal();showToast('ÄÃ£ thÃªm vÃ o giá»');}
function showToast(text){const toast=document.getElementById('toast');document.getElementById('toastText').textContent=text;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000);}
function updateCartBar(){const total=cart.reduce((s,item)=>{const topPrice=item.tops.reduce((ts,t)=>ts+t.price,0);return s+(item.price+topPrice)*item.qty;},0);const count=cart.reduce((s,item)=>s+item.qty,0);document.getElementById('cartCount').textContent=count;document.getElementById('cartTotal').textContent=total.toLocaleString()+'Ä‘';document.getElementById('cartSummaryTotal').textContent=total.toLocaleString()+'Ä‘';document.getElementById('cartBar').classList.toggle('show',cart.length>0);}
function openCartModal(){renderCartItems();document.getElementById('cartOverlay').classList.add('show');}
function closeCartModal(e){if(!e||e.target.id==='cartOverlay')document.getElementById('cartOverlay').classList.remove('show');}
function clearCart(){cart=[];updateCartBar();renderCartItems();showToast('ÄÃ£ xÃ³a giá» hÃ ng');}
function renderCartItems(){const container=document.getElementById('cartItems');const empty=document.getElementById('cartEmpty');if(cart.length===0){empty.style.display='block';container.innerHTML='';return;}empty.style.display='none';container.innerHTML=cart.map((item,idx)=>{const topPrice=item.tops.reduce((s,t)=>s+t.price,0);const itemTotal=(item.price+topPrice)*item.qty;const details=[...item.tops.map(t=>t.name),...item.notes,item.customNote].filter(Boolean).join(', ');return`<div class="cart-item"><img class="cart-item-img" src="${item.img}" onerror="this.src='/static/logo.png'"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div>${details?`<div class="cart-item-detail">${details}</div>`:''}<div class="cart-item-bottom"><span class="cart-item-price">${itemTotal.toLocaleString()}Ä‘</span><div class="cart-item-qty"><button class="cart-qty-btn ${item.qty===1?'delete':''}" onclick="changeCartQty(${idx},-1)">${item.qty===1?'ğŸ—‘':'âˆ’'}</button><span class="cart-item-num">${item.qty}</span><button class="cart-qty-btn" onclick="changeCartQty(${idx},1)">+</button></div></div></div></div>`;}).join('');}
function changeCartQty(idx,d){if(cart[idx].qty+d<=0){cart.splice(idx,1);}else{cart[idx].qty+=d;}updateCartBar();renderCartItems();}
function checkout(){const customer=document.getElementById('customerName').value.trim()||'KHÃCH Láºº';if(cart.length===0){showToast('Giá» hÃ ng trá»‘ng!');return;}const total=cart.reduce((s,item)=>{const topPrice=item.tops.reduce((ts,t)=>ts+t.price,0);return s+(item.price+topPrice)*item.qty;},0);const orderData={order_id:orderId,customer:customer,items:cart.map(item=>({name:item.name,price:item.price,qty:item.qty,tops:item.tops,notes:[...item.notes,item.customNote].filter(Boolean)})),total:total};if(window.Telegram&&Telegram.WebApp){Telegram.WebApp.sendData(JSON.stringify(orderData));}showToast('ÄÃ£ gá»­i Ä‘Æ¡n!');cart=[];updateCartBar();closeCartModal();}
renderProducts();
</script>
</body>
</html>
