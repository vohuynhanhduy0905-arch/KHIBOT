<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS Nh√¢n Vi√™n</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1A5336; --accent: #F4D03F; --bg: #f0f2f5; }
        body { background-color: var(--bg); font-family: -apple-system, sans-serif; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER KIOTVIET STYLE */
        .header-bar { background: var(--primary); color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cat-scroll { overflow-x: auto; white-space: nowrap; padding: 10px 0; -webkit-overflow-scrolling: touch; background: white; border-bottom: 1px solid #ddd; }
        .cat-chip { display: inline-block; padding: 6px 15px; margin-right: 8px; border-radius: 20px; background: #eee; color: #555; font-weight: 600; font-size: 14px; border: none; }
        .cat-chip.active { background: var(--primary); color: white; }

        /* DANH S√ÅCH M√ìN (LIST VIEW) */
        .product-item { background: white; padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; }
        .prod-img { width: 60px; height: 60px; border-radius: 6px; object-fit: cover; background: #eee; }
        .prod-info { flex: 1; }
        .prod-name { font-weight: 700; font-size: 15px; margin-bottom: 2px; color: #333; }
        .prod-price { color: var(--primary); font-weight: bold; }
        .btn-add { width: 35px; height: 35px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* MODAL CH·ªåN TOPPING */
        .modal-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; z-index: 2000; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
        .modal-bottom.show { transform: translateY(0); }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { overflow-y: auto; padding: 15px; flex: 1; }
        .section-title { font-size: 13px; font-weight: bold; text-transform: uppercase; color: #888; margin: 15px 0 8px; }
        
        /* Checkbox Topping ƒë·∫πp */
        .topping-item { display: flex; justify-content: space-between; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; align-items: center; }
        .topping-item.active { border-color: var(--primary); background: #e8f5e9; }
        .t-name { font-weight: 500; }
        .t-price { font-size: 13px; color: #666; }
        
        /* Note Tags */
        .note-tag { padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; font-size: 13px; margin-right: 5px; margin-bottom: 5px; display: inline-block; }
        .note-tag.active { background: #666; color: white; border-color: #666; }

        /* CART BAR */
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1500; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #eee; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; font-size: 16px; }
        
        /* Overlay */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1900; display: none; }
        .overlay.show { display: block; }

        /* Counter */
        .qty-box { display: flex; align-items: center; gap: 10px; background: #f5f5f5; padding: 5px; border-radius: 8px; }
        .qty-btn { width: 30px; height: 30px; background: white; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<!-- 1. HEADER -->
<div class="header-bar d-flex justify-content-between align-items-center">
    <div>
        <div style="font-size: 12px; opacity: 0.8;">ƒê∆°n #<span id="orderId">...</span></div>
        <input type="text" id="customerName" placeholder="T√™n kh√°ch..." style="background: rgba(255,255,255,0.2); border:none; color:white; padding: 4px 8px; border-radius: 4px; font-size: 14px; width: 150px; outline: none;">
    </div>
    <div style="font-weight: bold;">KH·ªà MILKTEA üêµ</div>
</div>

<!-- 2. CATEGORY -->
<div class="cat-scroll" id="catList">
    <!-- JS render -->
</div>

<!-- 3. LIST PRODUCT -->
<div id="productList" style="padding-bottom: 20px;">
    <!-- JS render -->
</div>

<!-- 4. CART BAR -->
<div class="cart-bar" id="cartBar" style="display: none !important;">
    <div>
        <div style="font-size: 13px; color: #666;"><span id="totalQty">0</span> m√≥n</div>
        <div style="font-size: 18px; font-weight: 800; color: var(--primary);" id="totalPrice">0ƒë</div>
    </div>
    <button class="btn-submit" onclick="submitOrder()">G·ª¨I B·∫æP üöÄ</button>
</div>

<!-- 5. MODAL -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal-bottom" id="modal">
    <div class="modal-header">
        <div>
            <div id="mName" style="font-weight: 800; font-size: 18px;">T√™n m√≥n</div>
            <div id="mBasePrice" style="color: var(--primary); font-weight: bold;">25,000ƒë</div>
        </div>
        <div class="qty-box">
            <button class="qty-btn" onclick="adjustQty(-1)">-</button>
            <span id="mQty" style="font-weight: bold; width: 20px; text-align: center;">1</span>
            <button class="qty-btn" onclick="adjustQty(1)">+</button>
        </div>
    </div>
     <div class="modal-body">
        
        <!-- 1. ƒê∆ØA GHI CH√ö L√äN ƒê·∫¶U -->
        <div class="section-title">üìù Ghi ch√∫ (ƒê√°/Ng·ªçt)</div>
        <div id="listNotes">
            <div class="note-tag" onclick="toggleNote(this)">√çt ƒë√°</div>
            <div class="note-tag" onclick="toggleNote(this)">Kh√¥ng ƒë√°</div>
            <div class="note-tag" onclick="toggleNote(this)">√çt ng·ªçt</div>
            <div class="note-tag" onclick="toggleNote(this)">Nhi·ªÅu ng·ªçt</div>
            <div class="note-tag" onclick="toggleNote(this)">Mang v·ªÅ</div>
        </div>

        <!-- 2. ƒê·∫æN PH·∫¶N CH·ªåN TOPPING (S·ª≠a ti√™u ƒë·ªÅ ƒë·ªÉ nh√¢n vi√™n hi·ªÉu) -->
        <div class="section-title" style="color: var(--primary); margin-top: 20px;">
            üçπ T√πy ch·ªçn Topping<br>
            <small style="font-weight: normal; color: #666; font-size: 11px;">(Kh√¥ng ch·ªçn = M·∫∑c ƒë·ªãnh Full Topping)</small>
        </div>
        
        <!-- Render danh s√°ch Topping -->
        <div id="listTopping5k"></div>
        <div id="listTopping10k"></div>
    </div>
    <div style="padding: 15px; border-top: 1px solid #eee;">
        <button class="btn-submit w-100" onclick="addToCart()">TH√äM (<span id="mBtnTotal">0</span>ƒë)</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const categories = [
        { id: 'trasua', name: 'Tr√† S·ªØa' },
        { id: 'traicay', name: 'Tr√† Tr√°i C√¢y' },
        { id: 'macchiato', name: 'Macchiato' },
        { id: 'dacbiet', name: 'ƒê·∫∑c Bi·ªát/Latte' },
        { id: 'topping', name: 'Topping Th√™m' } // <--- M·ªöI: Th√™m tab Topping
    ];

    const products = [
        // TR√Ä S·ªÆA (25K)
        { id: 1, cat: 'trasua', name: 'TS Truy·ªÅn Th·ªëng', price: 25000, img: 'https://img.icons8.com/emoji/96/bubble-tea-emoji.png' },
        { id: 2, cat: 'trasua', name: 'TS Matcha', price: 25000, img: 'https://img.icons8.com/emoji/96/bubble-tea-emoji.png' },
        { id: 3, cat: 'trasua', name: 'TS Caramel', price: 25000, img: 'https://img.icons8.com/emoji/96/bubble-tea-emoji.png' },
        { id: 4, cat: 'trasua', name: 'TS √î Long', price: 25000, img: 'https://img.icons8.com/emoji/96/bubble-tea-emoji.png' },
        { id: 5, cat: 'trasua', name: 'TS Chocolate', price: 25000, img: 'https://img.icons8.com/emoji/96/bubble-tea-emoji.png' },
        { id: 6, cat: 'trasua', name: 'TS ƒê√†o', price: 25000, img: 'https://img.icons8.com/emoji/96/bubble-tea-emoji.png' },

        // TR√Ä TR√ÅI C√ÇY (27K)
        { id: 10, cat: 'traicay', name: 'Tr√† ƒê√°c D√¢u T·∫±m', price: 27000, img: '/static/dautam.jpg' },
        { id: 11, cat: 'traicay', name: 'Tr√† ƒê√°c Th∆°m', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },
        { id: 12, cat: 'traicay', name: 'Tr√† ·ªîi H·ªìng', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },
        { id: 13, cat: 'traicay', name: 'Tr√† Nhi·ªát ƒê·ªõi', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },
        { id: 14, cat: 'traicay', name: 'Tr√† T√°o Xanh', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },
        { id: 15, cat: 'traicay', name: 'Tr√† D∆∞a L∆∞·ªõi', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },
        { id: 16, cat: 'traicay', name: 'Tr√† M√£ng C·∫ßu', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },
        { id: 17, cat: 'traicay', name: 'Tr√† C√≥c H·∫°t ƒê√°c', price: 27000, img: 'https://img.icons8.com/emoji/96/tropical-drink.png' },

        // MACCHIATO (25K)
        { id: 20, cat: 'macchiato', name: 'Tr√† ƒê√†o Macchiato', price: 25000, img: 'https://img.icons8.com/emoji/96/beverage-box-emoji.png' },
        { id: 21, cat: 'macchiato', name: 'Tr√† D√¢u Macchiato', price: 25000, img: 'https://img.icons8.com/emoji/96/beverage-box-emoji.png' },
        { id: 22, cat: 'macchiato', name: 'Tr√† V·∫£i Macchiato', price: 25000, img: 'https://img.icons8.com/emoji/96/beverage-box-emoji.png' },
        { id: 23, cat: 'macchiato', name: 'H·ªìng Tr√† Macchiato', price: 25000, img: 'https://img.icons8.com/emoji/96/beverage-box-emoji.png' },
        { id: 24, cat: 'macchiato', name: 'Tr√† √î Long Macchiato', price: 25000, img: 'https://img.icons8.com/emoji/96/beverage-box-emoji.png' },
        { id: 25, cat: 'macchiato', name: 'Tr√† Sen Macchiato', price: 25000, img: 'https://img.icons8.com/emoji/96/beverage-box-emoji.png' },

        // ƒê·∫∂C BI·ªÜT / LATTE
        { id: 30, cat: 'dacbiet', name: 'Tr√† S·ªßi', price: 25000, img: 'https://img.icons8.com/emoji/96/glass-of-milk.png' },
        { id: 31, cat: 'dacbiet', name: 'S·ªØa T∆∞∆°i Tr√¢n Ch√¢u ƒêƒê', price: 27000, img: 'https://img.icons8.com/emoji/96/glass-of-milk.png' },
        { id: 32, cat: 'dacbiet', name: 'H·ªìng Tr√† Latte', price: 27000, img: 'https://img.icons8.com/emoji/96/glass-of-milk.png' },
        { id: 33, cat: 'dacbiet', name: 'Matcha Latte', price: 27000, img: 'https://img.icons8.com/emoji/96/glass-of-milk.png' },
        // 1. Nh√≥m Topping 5k
        { id: 90, cat: 'topping', name: 'Th√™m Tr√¢n Ch√¢u', price: 5000, img: 'https://img.icons8.com/color/96/boiling-bubbles.png' },
        { id: 91, cat: 'topping', name: 'Th√™m C·ªß NƒÉng', price: 5000, img: 'https://img.icons8.com/color/96/ingredients.png' },
        { id: 92, cat: 'topping', name: 'Th√™m Ph√¥ Mai', price: 5000, img: 'https://img.icons8.com/color/96/cheese.png' },
        { id: 93, cat: 'topping', name: 'Th√™m Rau C√¢u', price: 5000, img: 'https://img.icons8.com/color/96/jelly.png' },
        { id: 94, cat: 'topping', name: 'Th√™m Kh√∫c B·∫°ch', price: 5000, img: 'https://img.icons8.com/color/96/tofu.png' },
        { id: 95, cat: 'topping', name: 'Th√™m S∆∞∆°ng S√°o', price: 5000, img: 'https://img.icons8.com/color/96/jelly-band.png' },
        { id: 96, cat: 'topping', name: 'Th√™m Th·∫°ch ƒê√†o', price: 5000, img: 'https://img.icons8.com/color/96/peach.png' },
        { id: 97, cat: 'topping', name: 'Th√™m Flan Tr·ª©ng', price: 5000, img: 'https://img.icons8.com/color/96/creme-caramel.png' },
        { id: 98, cat: 'topping', name: 'Th√™m Ng·ªçc Trai', price: 5000, img: 'https://img.icons8.com/color/96/pearl.png' },
        { id: 99, cat: 'topping', name: 'Th√™m Khoai D·∫ªo', price: 5000, img: 'https://img.icons8.com/color/96/potato.png' },

        // 2. Nh√≥m Topping Tr√°i C√¢y (Gi·∫£ ƒë·ªãnh 10k/ph·∫ßn th√™m)
        { id: 100, cat: 'topping', name: 'Th√™m ƒê√°c Th∆°m', price: 10000, img: 'https://img.icons8.com/color/96/pineapple.png' },
        { id: 101, cat: 'topping', name: 'Th√™m ƒê√°c D√¢u T·∫±m', price: 10000, img: 'https://img.icons8.com/color/96/raspberry.png' },
        { id: 102, cat: 'topping', name: 'Th√™m TC Nhi·ªát ƒê·ªõi', price: 10000, img: 'https://img.icons8.com/color/96/fruit-bag.png' },
        { id: 104, cat: 'topping', name: 'Th√™m D∆∞a L∆∞·ªõi', price: 10000, img: 'https://img.icons8.com/color/96/melon.png' },
        { id: 105, cat: 'topping', name: 'Th√™m ·ªîi H·ªìng', price: 10000, img: 'https://img.icons8.com/color/96/guava.png' },
        { id: 106, cat: 'topping', name: 'Th√™m M√£ng C·∫ßu', price: 10000, img: 'https://img.icons8.com/color/96/custard-apple.png' },
    ];

    const topping5k = ["Tr√¢n Ch√¢u", "C·ªß NƒÉng", "Ph√¥ Mai", "Rau C√¢u", "Kh√∫c B·∫°ch", "S∆∞∆°ng S√°o", "Th·∫°ch ƒê√†o", "Flan Tr·ª©ng", "Ng·ªçc Trai", "Khoai D·∫ªo"];
    const topping10k = ["ƒê√°c Th∆°m", "ƒê√°c D√¢u T·∫±m", "Tr√°i C√¢y Nhi·ªát ƒê·ªõi", "T√°o Xanh", "D∆∞a L∆∞·ªõi", "·ªîi H·ªìng", "M√£ng C·∫ßu"];

    let cart = [];
    let currentItem = null;

    // --- INIT ---
    function init() {
        document.getElementById('orderId').innerText = Math.floor(Math.random() * 900) + 100;
        
        // Render Cats
        const cList = document.getElementById('catList');
        categories.forEach((c, i) => {
            cList.innerHTML += `<button class="cat-chip ${i===0?'active':''}" onclick="filter('${c.id}', this)">${c.name}</button>`;
        });

        renderProd('trasua');
    }

    function filter(catId, btn) {
        document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderProd(catId);
    }

    function renderProd(catId) {
        const pList = document.getElementById('productList');
        pList.innerHTML = '';
        products.filter(p => p.cat === catId).forEach(p => {
            pList.innerHTML += `
                <div class="product-item" onclick="openModal(${p.id})">
                    <img src="${p.img}" class="prod-img">
                    <div class="prod-info">
                        <div class="prod-name">${p.name}</div>
                        <div class="prod-price">${p.price.toLocaleString()}ƒë</div>
                    </div>
                    <button class="btn-add">+</button>
                </div>
            `;
        });
    }

    // --- MODAL LOGIC ---
    function openModal(id) {
        const p = products.find(x => x.id === id);
        currentItem = { ...p, qty: 1, tops: [], notes: [] };
        
        document.getElementById('mName').innerText = p.name;
        document.getElementById('mBasePrice').innerText = p.price.toLocaleString() + 'ƒë';
        document.getElementById('mQty').innerText = 1;

        // Render Toppings 
        const t5 = document.getElementById('listTopping5k');
        t5.innerHTML = topping5k.map(t => `
            <div class="topping-item" onclick="toggleTop(this, '${t}', 0)"> <!-- Truy·ªÅn gi√° 0 -->
                <span class="t-name">${t}</span> 
                <!-- ƒê√£ x√≥a th·∫ª span hi·ªÉn th·ªã gi√° +5k -->
            </div>`).join('');

        const t10 = document.getElementById('listTopping10k');
        t10.innerHTML = topping10k.map(t => `
            <div class="topping-item" onclick="toggleTop(this, '${t}', 0)"> <!-- Truy·ªÅn gi√° 0 -->
                <span class="t-name">${t}</span> 
                <!-- ƒê√£ x√≥a th·∫ª span hi·ªÉn th·ªã gi√° +10k -->
            </div>`).join('');

        // Reset Notes
        document.querySelectorAll('.note-tag').forEach(n => n.classList.remove('active'));

        calcModalPrice();
        document.getElementById('overlay').classList.add('show');
        document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('overlay').classList.remove('show');
        document.getElementById('modal').classList.remove('show');
    }

    function toggleTop(el, name, price) {
        el.classList.toggle('active');
        if(el.classList.contains('active')) {
            // Gi√° 0ƒë v√¨ ƒë√¢y l√† ch·ªçn trong ph·∫ßn c√≥ s·∫µn, kh√¥ng ph·∫£i mua th√™m
            currentItem.tops.push({name, price: 0}); 
        } else {
            currentItem.tops = currentItem.tops.filter(t => t.name !== name);
        }
        calcModalPrice();
    }

    function toggleNote(el) {
        el.classList.toggle('active');
        const txt = el.innerText;
        if(el.classList.contains('active')) currentItem.notes.push(txt);
        else currentItem.notes = currentItem.notes.filter(n => n !== txt);
    }

    function adjustQty(n) {
        if(currentItem.qty + n > 0) {
            currentItem.qty += n;
            document.getElementById('mQty').innerText = currentItem.qty;
            calcModalPrice();
        }
    }

    function calcModalPrice() {
        let toppingPrice = currentItem.tops.reduce((sum, t) => sum + t.price, 0);
        let total = (currentItem.price + toppingPrice) * currentItem.qty;
        document.getElementById('mBtnTotal').innerText = total.toLocaleString();
    }

    function addToCart() {
        cart.push(currentItem);
        closeModal();
        updateCartBar();
    }

    function updateCartBar() {
        const bar = document.getElementById('cartBar');
        if(cart.length > 0) {
            bar.style.setProperty('display', 'flex', 'important');
            const qty = cart.reduce((s, i) => s + i.qty, 0);
            const total = cart.reduce((s, i) => {
                let tPrice = i.tops.reduce((a, b) => a + b.price, 0);
                return s + ((i.price + tPrice) * i.qty);
            }, 0);
            
            document.getElementById('totalQty').innerText = qty;
            document.getElementById('totalPrice').innerText = total.toLocaleString() + 'ƒë';
        } else {
            bar.style.display = 'none';
        }
    }

    function submitOrder() {
    const total = cart.reduce((s, i) => {
        let tPrice = i.tops.reduce((a, b) => a + b.price, 0);
        return s + ((i.price + tPrice) * i.qty);
    }, 0);

    // L·∫•y t√™n nh√¢n vi√™n t·ª´ Telegram
    const userName = tg.initDataUnsafe?.user?.first_name || "Nh√¢n vi√™n";

    const orderData = {
        customer: document.getElementById('customerName').value || 'Kh√°ch l·∫ª',
        items: cart,
        total: total,
        user_name: userName
    };

    // G·ª≠i d·ªØ li·ªáu v·ªÅ Server FastAPI thay v√¨ d√πng tg.sendData
    fetch('/api/submit_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData),
    })
    .then(response => {
        if (response.ok) {
            // N·∫øu g·ª≠i th√†nh c√¥ng th√¨ m·ªõi ƒë√≥ng App
            tg.close(); 
        } else {
            alert("L·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!");
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!");
    });
}

    init();
</script>
</body>

</html>


